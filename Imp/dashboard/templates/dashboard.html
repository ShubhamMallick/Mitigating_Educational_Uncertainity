<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Education Dashboard - Comprehensive Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --success: #4bb543;
            --warning: #f9c74f;
            --danger: #ef476f;
            --dark: #212529;
            --light: #f8f9fa;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }

        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header-section {
            background: var(--gradient);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 20s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-30px, -30px) rotate(180deg); }
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stat-icon.primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .stat-icon.success { background: linear-gradient(135deg, var(--success), #2e7d32); color: white; }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning), #f57c00); color: white; }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger), #c62828); color: white; }
        .stat-icon.info { background: linear-gradient(135deg, var(--accent), #0288d1); color: white; }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .activity-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .achievement-badge {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin: 5px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .recommendation-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }
        
        .recommendation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .career-path-card {
            border-left: 4px solid #4361ee;
            transition: all 0.3s ease;
        }
        
        .career-path-card:hover {
            border-left-color: #00d084;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .risk-indicator {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }

        .risk-level {
            height: 100%;
            transition: width 1s ease;
            border-radius: 4px;
        }

        .risk-low { background: linear-gradient(90deg, var(--success), #66bb6a); }
        .risk-medium { background: linear-gradient(90deg, var(--warning), #ffa726); }
        .risk-high { background: linear-gradient(90deg, var(--danger), #ef5350); }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--gray);
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: var(--gradient);
            color: white;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .skill-progress {
            height: 6px;
            border-radius: 3px;
            background: #e9ecef;
            overflow: hidden;
        }

        .skill-progress-bar {
            height: 100%;
            background: var(--gradient);
            transition: width 1s ease;
        }

        /* Risk Assessment Styles */
        .risk-score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(
                #ef476f 0deg 118deg,
                #f9c74f 118deg 236deg,
                #4bb543 236deg 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }

        .risk-score-circle::before {
            content: '';
            position: absolute;
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
        }

        .risk-score-circle span {
            position: relative;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .risk-factor .progress {
            height: 8px;
        }

        .timeline-activity {
            position: relative;
            padding-left: 40px;
            margin-bottom: 20px;
        }

        .timeline-activity::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: -20px;
            width: 2px;
            background: #e9ecef;
        }

        .timeline-dot {
            position: absolute;
            left: 10px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
        }

        /* Risk Factor Analysis Animations */
        .risk-analysis-container {
            padding: 1rem 0;
        }

        .risk-factor-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .risk-factor-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .risk-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(var(--bs-primary-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .risk-progress {
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .risk-progress-bar {
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .risk-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.3) 50%, 
                rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .risk-value-badge {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            min-width: 80px;
            text-align: center;
        }

        .badge-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .animate-slide-in {
            transform: translateY(20px);
            opacity: 1; /* Changed from 0 to 1 to make content visible */
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-primary-dark, #0056b3) 100%) !important;
        }

        /* Pulse animation for live badge */
        .badge.bg-white.text-primary {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(13, 110, 253, 0); }
            100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
        }

        /* Assessment Data Animations */
        .assessment-data-container {
            padding: 1rem 0;
        }

        .assessment-accordion .accordion-item {
            border: none;
            border-radius: 12px !important;
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .assessment-accordion .accordion-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .assessment-header .assessment-button {
            background: transparent;
            border: none;
            padding: 1rem 1.25rem;
            box-shadow: none;
            font-weight: 600;
            color: var(--bs-dark);
        }

        .assessment-header .assessment-button:not(.collapsed) {
            background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-primary-dark, #0056b3) 100%);
            color: white;
        }

        .assessment-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(var(--bs-primary-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: var(--bs-primary);
            transition: all 0.3s ease;
        }

        .assessment-header .assessment-button:not(.collapsed) .assessment-icon {
            background: rgba(255,255,255,0.2);
            color: white;
            transform: scale(1.1);
        }

        .assessment-body {
            padding: 1.5rem;
            background: rgba(248,249,250,0.5);
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            transform: translateY(10px);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--bs-primary);
        }

        .metric-badge {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.4rem 0.6rem;
            border-radius: 8px;
            min-width: 70px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-progress {
            background-color: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .metric-progress-bar {
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .metric-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.4) 50%, 
                rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }

        .metric-status {
            opacity: 1;
            /* animation: fadeInUp 0.5s ease forwards;
            animation-delay: 1s; */
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            /* Animation styles - can be activated when needed */
            transform: translateY(20px);
            opacity: 1; /* Changed from 0 to 1 to make content visible */
            transition: all 0.6s ease;
        }
        
        .animate-fade-in.active {
            transform: translateY(0);
            opacity: 1;
        }

        /* Enhanced accordion animations */
        .assessment-accordion .accordion-collapse {
            transition: all 0.4s ease;
        }

        .assessment-accordion .accordion-button::after {
            transition: transform 0.3s ease;
        }

        .assessment-accordion .accordion-button:not(.collapsed)::after {
            transform: rotate(180deg);
        }
        
        /* Career Mapping Tab Animations and Styling */
        
        /* Animated Title */
        .animated-title {
            animation: slideInLeft 0.8s ease-out;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        
        /* Career Assessment Button */
        .career-assessment-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: slideInRight 0.8s ease-out;
        }
        
        .career-assessment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .career-assessment-btn .btn-icon {
            transition: transform 0.3s ease;
        }
        
        .career-assessment-btn:hover .btn-icon {
            transform: translateX(3px);
        }
        
        /* Career Cards Container */
        .career-cards-container {
            /* Animation disabled to prevent visibility issues */
            opacity: 1;
            visibility: visible;
        }
        
        .career-paths-section {
            /* Animation disabled to prevent visibility issues */
            opacity: 1;
            visibility: visible;
        }
        
        .skills-courses-section {
            /* Animation disabled to prevent visibility issues */
            opacity: 1;
            visibility: visible;
        }
        
        /* Enhanced Chart Cards */
        .career-chart-card,
        .career-summary-card,
        .career-paths-card,
        .skills-card,
        .courses-card {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .career-chart-card:hover,
        .career-summary-card:hover,
        .career-paths-card:hover,
        .skills-card:hover,
        .courses-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* Card Header Gradients */
        .card-header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .card-header-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .career-chart-card:hover .card-header-gradient::before,
        .career-summary-card:hover .card-header-gradient::before,
        .career-paths-card:hover .card-header-gradient::before,
        .skills-card:hover .card-header-gradient::before,
        .courses-card:hover .card-header-gradient::before {
            left: 100%;
        }
        
        .card-header-gradient h5 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Content Areas */
        .chart-content,
        .summary-content,
        .paths-content,
        .courses-content {
            padding: 25px;
            min-height: 300px;
            position: relative;
        }
        
        /* Additional Animations */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        
        .animate-fade-in {
            /* Removed problematic animation - content should be visible by default */
        }
        
        /* Career Path Cards */
        .career-path-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .career-path-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .career-path-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .career-path-card .card-body {
            padding: 20px;
        }
        
        .career-score-badge {
            background: linear-gradient(135deg, #4bb543 0%, #3d8b40 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .career-compatibility-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .career-compatibility-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 1s ease-out;
            position: relative;
        }
        
        .career-compatibility-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* Course List Enhancement */
        .course-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .course-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .course-item:hover::before {
            left: 100%;
        }
        
        .course-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .course-explore-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .course-explore-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }
        
        /* Empty States */
        .career-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .career-empty-state i {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .career-empty-state h5 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .career-empty-state p {
            font-size: 1.1rem;
            margin-bottom: 25px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .career-assessment-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .animated-title h5 {
                font-size: 1.2rem;
            }
            
            .card-header-gradient {
                padding: 15px;
            }
            
            .chart-content,
            .summary-content,
            .paths-content,
            .courses-content {
                padding: 15px;
            }
        }
    /* Stream Assessment Form Styles */
        .form-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-section:hover {
            border-color: var(--primary);
            box-shadow: 0 3px 10px rgba(67, 97, 238, 0.1);
        }

        .form-range {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
        }

        .form-range::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gradient);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .form-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gradient);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .result-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            animation: fadeInUp 0.5s ease;
        }

        .ai-insights {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #bbdefb;
        }

        .insights-content {
            margin-top: 15px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header Section -->
        <div class="header-section">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-3"><i class="fas fa-chart-line me-3"></i>AI Education Dashboard</h1>
                    <p class="mb-0 opacity-75">Comprehensive Analytics & Progress Tracking</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="me-3">
                            <small class="d-block opacity-75">Welcome back,</small>
                            <strong id="userName">Student</strong>
                        </div>
                        <div class="stat-icon info">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <h3 id="profileCompletion" class="mb-1">0%</h3>
                    <p class="text-muted mb-0">Profile Completion</p>
                    <small class="text-success"><i class="fas fa-arrow-up"></i> +12% this week</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h3 id="skillsMastered" class="mb-1">0/10</h3>
                    <p class="text-muted mb-0">Skills Mastered</p>
                    <small class="text-success"><i class="fas fa-arrow-up"></i> +2 skills</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3 id="activeCourses" class="mb-1">0</h3>
                    <p class="text-muted mb-0">Active Courses</p>
                    <small id="recommendedCourses" class="text-info">0 recommended</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 id="riskLevel" class="mb-1">Low</h3>
                    <p class="text-muted mb-0">Risk Level</p>
                    <div class="risk-indicator mt-2">
                        <div class="risk-level risk-low" style="width: 25%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#overview">
                    <i class="fas fa-chart-pie me-2"></i>Overview
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#colleges">
                    <i class="fas fa-university me-2"></i>Selected Colleges
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#activities">
                    <i class="fas fa-history me-2"></i>Activities
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tracking-scores">
                    <i class="fas fa-chart-line me-2"></i>Tracking Scores
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#risk-assessment">
                    <i class="fas fa-exclamation-triangle me-2"></i>Risk Assessment
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#career-paths">
                    <i class="fas fa-route me-2"></i>Career Paths
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#recommendations">
                    <i class="fas fa-water me-2"></i>Stream Recommendation
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#course-recommendations">
                    <i class="fas fa-graduation-cap me-2"></i>Course Recommendation
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview">
                <div class="row">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-chart-area me-2"></i>Activity Timeline</h5>
                            <div id="activityChart"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Module Usage</h5>
                            <div id="moduleChart"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Weekly Activity</h5>
                            <div id="weeklyChart"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-clock me-2"></i>Engagement Metrics</h5>
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <h4 id="totalSessions" class="text-primary">0</h4>
                                    <small class="text-muted">Total Sessions</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <h4 id="avgSessionDuration" class="text-info">0m</h4>
                                    <small class="text-muted">Avg Duration</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <h4 id="mostActiveHour" class="text-success">0</h4>
                                    <small class="text-muted">Most Active Hour</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <h4 id="mostActiveDay" class="text-warning">-</h4>
                                    <small class="text-muted">Most Active Day</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-history me-2"></i>Recent Activities</h5>
                            <div id="recentActivitiesList" class="timeline-activities">
                                <!-- Activities will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selected Colleges Tab -->
            <div class="tab-pane fade" id="colleges">
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-university me-2"></i> Your Selected Colleges</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshSelectedColleges()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                    <a href="/institution_directory/" class="btn btn-sm btn-primary">
                                        <i class="fas fa-plus me-1"></i>Add More Colleges
                                    </a>
                                </div>
                            </div>
                            <div id="selectedCollegesContainer">
                                <div class="text-center py-5">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">Loading your selected colleges...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- College Comparison Section -->
                <div class="row mt-4" id="comparisonSection" style="display: none;">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i> Compare Selected Colleges</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="closeComparison()">
                                    <i class="fas fa-times me-1"></i>Close
                                </button>
                            </div>
                            <div id="comparisonContainer">
                                <!-- Comparison content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- College Details Modal -->
            <div class="modal fade" id="collegeDetailsModal" tabindex="-1" aria-labelledby="collegeDetailsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="collegeDetailsModalLabel">
                                <i class="fas fa-university me-2"></i>College Details
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="collegeDetailsContent">
                                <div class="text-center py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">Loading college details...</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="#" id="collegeWebsiteLink" class="btn btn-primary" target="_blank">
                                <i class="fas fa-external-link-alt me-2"></i>Visit Website
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activities Tab -->
            <div class="tab-pane fade" id="activities">
                <div class="row">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-list me-2"></i>Recent Activities</h5>
                            <div id="activitiesList"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Activity Breakdown</h5>
                            <div id="activityBreakdownChart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Tracking Scores Tab -->
            <div class="tab-pane fade" id="tracking-scores">
                <div class="row">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Score Progress Over Time</h5>
                            <div id="scoreProgressChart"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-trophy me-2"></i>Score Statistics</h5>
                            <div class="row text-center">
                                <div class="col-12 mb-3">
                                    <h4 id="highestScore" class="text-success">0</h4>
                                    <small class="text-muted">Highest Score</small>
                                </div>
                                <div class="col-12 mb-3">
                                    <h4 id="averageScore" class="text-primary">0</h4>
                                    <small class="text-muted">Average Score</small>
                                </div>
                                <div class="col-12 mb-3">
                                    <h4 id="totalAssessments" class="text-info">0</h4>
                                    <small class="text-muted">Total Assessments</small>
                                </div>
                                <div class="col-12 mb-3">
                                    <h4 id="improvementRate" class="text-warning">0%</h4>
                                    <small class="text-muted">Improvement Rate</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Access to Quizzes -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-rocket me-2"></i>Quick Access to Quizzes</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <a href="/interest-quizzes/subject" class="btn btn-success btn-lg w-100 py-3">
                                        <i class="fas fa-book me-2"></i>
                                        <strong>Subject Quizzes</strong>
                                        <br><small>Test your knowledge in academic subjects</small>
                                    </a>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <a href="/interest-quizzes/aptitude" class="btn btn-warning btn-lg w-100 py-3">
                                        <i class="fas fa-brain me-2"></i>
                                        <strong>Aptitude Quizzes</strong>
                                        <br><small>Assess your cognitive abilities and skills</small>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz Breakdown Section -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Quiz Performance Breakdown</h5>
                            <div id="quizBreakdown">
                                <!-- Quiz breakdown will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-list-alt me-2"></i>Assessment Score History</h5>
                            <div id="scoreHistoryList">
                                <!-- Score history will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Career Paths Tab -->
            <div class="tab-pane fade" id="career-paths">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="animated-title">
                                <h5 class="mb-0">
                                    <i class="fas fa-route me-2 animate-pulse"></i>
                                    <span class="gradient-text">Career Mapping</span>
                                </h5>
                                <p class="text-muted mb-0 mt-1">Discover your perfect career path based on your skills and interests</p>
                            </div>
                            <button class="btn btn-primary btn-lg career-assessment-btn" onclick="goToCareerAssessment()">
                                <i class="fas fa-clipboard-list me-2"></i>
                                <span>Take Career Assessment</span>
                                <i class="fas fa-arrow-right ms-2 btn-icon"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Animated Career Cards -->
                <div class="row career-cards-container">
                    <div class="col-md-8 mb-4">
                        <div class="chart-container career-chart-card">
                            <div class="card-header-gradient">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Career Compatibility Chart
                                    <span class="badge bg-white text-primary ms-2 animate-fade-in">Live Analysis</span>
                                </h5>
                            </div>
                            <div id="careerCompatibilityChart" class="chart-content">
                                <!-- Career compatibility chart will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="chart-container career-summary-card">
                            <div class="card-header-gradient">
                                <h5 class="mb-0">
                                    <i class="fas fa-compass me-2"></i>
                                    Career Assessment Summary
                                </h5>
                            </div>
                            <div id="careerAssessmentSummary" class="summary-content">
                                <!-- Career assessment summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Career Paths Section -->
                <div class="row career-paths-section">
                    <div class="col-md-12">
                        <div class="chart-container career-paths-card">
                            <div class="card-header-gradient">
                                <h5 class="mb-0">
                                    <i class="fas fa-briefcase me-2"></i>
                                    Recommended Career Paths
                                    <span class="badge bg-white text-success ms-2 animate-fade-in">Top 5 Matches</span>
                                </h5>
                            </div>
                            <div id="careerPathsList" class="paths-content">
                                <!-- Career paths will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Skills and Courses Section -->
                <div class="row skills-courses-section">
                    <div class="col-md-6 mb-4">
                        <div class="chart-container skills-card">
                            <div class="card-header-gradient">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-radar me-2"></i>
                                    Skills Analysis
                                </h5>
                            </div>
                            <div id="skillsRadarChart" class="chart-content">
                                <!-- Skills radar chart will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="chart-container courses-card">
                            <div class="card-header-gradient">
                                <h5 class="mb-0">
                                    <i class="fas fa-graduation-cap me-2"></i>
                                    Suggested Courses
                                </h5>
                            </div>
                            <div id="suggestedCoursesList" class="courses-content">
                                <!-- Suggested courses will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stream Recommendation Tab -->
            <div class="tab-pane fade" id="recommendations">
                <div class="row">
                    <div class="col-md-12">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="mb-0"><i class="fas fa-water me-2"></i>Stream Recommendation Results</h5>
                                    <p class="text-muted mb-0">View your stream assessment results and personalized recommendations from the training page.</p>
                                </div>
                                <div>
                                    <button class="btn btn-outline-warning btn-sm me-2" onclick="testStreamData()">
                                        <i class="fas fa-bug me-1"></i>Test Data
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadStreamRecommendationData()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Stream Results Display -->
                            <div id="streamResultsContainer">
                                <div id="noStreamData" class="text-center py-5">
                                    <i class="fas fa-water fa-3x text-muted mb-3"></i>
                                    <h6 class="text-muted">No Stream Assessment Data</h6>
                                    <p class="text-muted">Complete your stream assessment on the training page to see your recommendations here.</p>
                                    <a href="/training/" class="btn btn-primary">
                                        <i class="fas fa-arrow-left me-2"></i>Go to Stream Assessment
                                    </a>
                                </div>
                                
                                <div id="streamDataDisplay" style="display: none;">
                                    <!-- Stream recommendation data will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Recommendation Tab -->
            <div class="tab-pane fade" id="course-recommendations">
                <div class="row">
                    <div class="col-md-12">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Course Recommendation Results</h5>
                                    <p class="text-muted mb-0">View your course assessment results from the respective course recommendation systems.</p>
                                </div>
                                <div>
                                    <button class="btn btn-outline-warning btn-sm me-2" onclick="testCourseData()">
                                        <i class="fas fa-bug me-1"></i>Test Data
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadCourseRecommendationData()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Course Results Display -->
                            <div id="courseResultsContainer">
                                <div id="noCourseData" class="text-center py-5">
                                    <i class="fas fa-graduation-cap fa-3x text-muted mb-3"></i>
                                    <h6 class="text-muted">No Course Recommendations Data</h6>
                                    <p class="text-muted">Complete course assessments on the respective course recommendation pages to see your recommendations here.</p>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-palette fa-2x text-primary mb-2"></i>
                                                    <h6>Arts Courses</h6>
                                                    <a href="/arts/courses/" class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-arrow-right me-1"></i>Get Recommendations
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-coins fa-2x text-success mb-2"></i>
                                                    <h6>Commerce Courses</h6>
                                                    <a href="/commerce/courses/" class="btn btn-outline-success btn-sm">
                                                        <i class="fas fa-arrow-right me-1"></i>Get Recommendations
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-flask fa-2x text-info mb-2"></i>
                                                    <h6>PCM Courses</h6>
                                                    <a href="/pcm/courses/" class="btn btn-outline-info btn-sm">
                                                        <i class="fas fa-arrow-right me-1"></i>Get Recommendations
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-microscope fa-2x text-danger mb-2"></i>
                                                    <h6>PCB Courses</h6>
                                                    <a href="/pcb/courses/" class="btn btn-outline-danger btn-sm">
                                                        <i class="fas fa-arrow-right me-1"></i>Get Recommendations
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-tools fa-2x text-warning mb-2"></i>
                                                    <h6>Vocational Courses</h6>
                                                    <a href="/vocational/courses/" class="btn btn-outline-warning btn-sm">
                                                        <i class="fas fa-arrow-right me-1"></i>Get Recommendations
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="courseDataDisplay" style="display: none;">
                                    <!-- Course recommendation data will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Assessment Tab -->
            <div class="tab-pane fade" id="risk-assessment">
                <div class="row">
                    <div class="col-lg-6">
                        <!-- Risk Score Card -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-exclamation-triangle me-2"></i> Dropout Risk Assessment
                            </div>
                            <div class="card-body text-center">
                                <div id="riskScoreDisplay" class="mb-3">
                                    <div class="risk-score-circle">
                                        <span id="riskPercentage">Loading...</span>
                                    </div>
                                    <h4 id="riskLevel" class="text-muted">No Assessment</h4>
                                    <p id="riskDescription" class="text-muted">Complete a risk assessment to see your results.</p>
                                </div>
                                <button class="btn btn-primary" onclick="startRiskAssessment()">
                                    <i class="fas fa-clipboard-check me-2"></i>Start Assessment
                                </button>
                            </div>
                        </div>

                        <!-- Form Data Display -->
                        <div class="card mb-4">
                            <div class="card-header bg-gradient-success text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">
                                            <i class="fas fa-clipboard-data me-2"></i> 
                                            Assessment Metrics
                                        </h5>
                                        <small class="opacity-75">Detailed performance indicators and form responses</small>
                                    </div>
                                    <div class="badge bg-white text-success">
                                        <i class="fas fa-database me-1"></i> Raw Data
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="formDataDisplay">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                                        <p>Complete a risk assessment to see your form data.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <!-- Risk Breakdown -->
                        <div class="card mb-4">
                            <div class="card-header bg-gradient-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">
                                            <i class="fas fa-chart-bar me-2"></i> 
                                            Risk Factor Analysis
                                        </h5>
                                        <small class="opacity-75">Detailed breakdown of contributing risk factors</small>
                                    </div>
                                    <div class="badge bg-white text-primary">
                                        <i class="fas fa-analytics me-1"></i> Live Analysis
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="riskBreakdown">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-chart-pie fa-2x mb-2"></i>
                                        <p>Complete a risk assessment to see detailed breakdown.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-lightbulb me-2"></i> Recommendations
                            </div>
                            <div class="card-body">
                                <div id="riskRecommendations">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-lightbulb fa-2x mb-2"></i>
                                        <p>Complete a risk assessment to get personalized recommendations.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading your dashboard...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.min.js"></script>
    <script>
        // Dashboard JavaScript
        let currentUserId = null;
        let dashboardData = null;
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        function initializeDashboard() {
            // Get or create user ID
            currentUserId = getUserIdFromStorage() || createUserId();
            
            // Load dashboard data
            loadDashboardData();
            
            // Set up auto-refresh
            setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
        }

        function getUserIdFromStorage() {
            // First check if user_id is in URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            
            if (urlUserId) {
                // Store it in localStorage for future use
                localStorage.setItem('dashboard_user_id', urlUserId);
                return urlUserId;
            }
            
            // Otherwise get from localStorage
            return localStorage.getItem('dashboard_user_id');
        }

        function createUserId() {
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('dashboard_user_id', userId);
            return userId;
        }

        async function loadDashboardData() {
            showLoading(true);
            hideError();
            
            try {
                // Load comprehensive dashboard data first
                const dashboardResponse = await fetch(`/api/dashboard/${currentUserId}`);
                
                if (!dashboardResponse.ok) {
                    throw new Error(`HTTP error! status: ${dashboardResponse.status}`);
                }
                
                const contentType = dashboardResponse.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server returned non-JSON response. Please check if the backend is running correctly.');
                }
                
                const comprehensiveData = await dashboardResponse.json();
                
                if (comprehensiveData.error) {
                    throw new Error(comprehensiveData.error);
                }
                
                dashboardData = comprehensiveData;
                
                // Load detailed stats
                const statsResponse = await fetch(`/api/dashboard/stats/${currentUserId}`);
                
                if (!statsResponse.ok) {
                    throw new Error(`HTTP error! status: ${statsResponse.status}`);
                }
                
                const statsContentType = statsResponse.headers.get('content-type');
                if (!statsContentType || !statsContentType.includes('application/json')) {
                    throw new Error('Stats endpoint returned non-JSON response');
                }
                
                const statsData = await statsResponse.json();
                
                if (statsData.status === 'success') {
                    updateDashboardUI(statsData);
                    
                    // Also update career paths from comprehensive data
                    if (comprehensiveData && comprehensiveData.career_data) {
                        console.log('Found comprehensive career data, calling updateCareerPaths');
                        console.log('comprehensiveData.career_data:', comprehensiveData.career_data);
                        updateCareerPaths(comprehensiveData.career_data);
                    } else {
                        console.log('No comprehensive career data found');
                        console.log('comprehensiveData:', comprehensiveData);
                    }
                }
                
                // Load activities
                const activitiesResponse = await fetch(`/api/dashboard/activities/${currentUserId}?limit=20`);
                
                if (!activitiesResponse.ok) {
                    throw new Error(`HTTP error! status: ${activitiesResponse.status}`);
                }
                
                const activitiesContentType = activitiesResponse.headers.get('content-type');
                if (!activitiesContentType || !activitiesContentType.includes('application/json')) {
                    throw new Error('Activities endpoint returned non-JSON response');
                }
                
                const activitiesData = await activitiesResponse.json();
                
                if (activitiesData.status === 'success') {
                    updateActivitiesUI(activitiesData);
                    
                    // Add activities data to dashboardData for charts
                    if (dashboardData) {
                        dashboardData.activities = activitiesData.activities || [];
                        console.log(' Added activities to dashboardData:', dashboardData.activities);
                        // Update charts again with activities data
                        updateCharts(dashboardData);
                    }
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data: ' + error.message + '\n\nPlease ensure the backend server is running on the correct port.');
            } finally {
                showLoading(false);
            }
        }

        function updateDashboardUI(data) {
            // Update basic stats
            if (data.basic_stats) {
                updateBasicStats(data.basic_stats);
            }
            
            // Update engagement metrics
            if (data.engagement_metrics) {
                updateEngagementMetrics(data.engagement_metrics);
            }
            
            // Update tracking scores
            if (data.tracking_scores) {
                updateTrackingScores(data.tracking_scores);
            }
            
            // Update charts with comprehensive data
            if (dashboardData) {
                console.log(' Updating charts with dashboard data:', dashboardData);
                updateCharts(dashboardData);
            }
            
            // Update career paths
            if (data.career_data) {
                console.log('Calling updateCareerPaths from updateDashboardUI');
                console.log('data.career_data:', data.career_data);
                updateCareerPaths(data.career_data);
            } else {
                console.log('No career_data found in updateDashboardUI');
            }
            
            // Update recommendations with course recommendations data
            if (data.course_recommendations) {
                console.log('Course recommendations received:', data.course_recommendations);
                // Wait for DOM to be ready before updating recommendations
                setTimeout(() => {
                    updateRecommendations(data.course_recommendations);
                }, 100);
            } else {
                console.log('No course_recommendations found in updateDashboardUI');
            }
            
            // Update general recommendations
            if (data.recommendations) {
                console.log('General recommendations received:', data.recommendations);
                setTimeout(() => {
                    updateGeneralRecommendations(data.recommendations);
                }, 150);
            } else {
                console.log('No general recommendations in data, showing fallback');
                // Show fallback message if no general recommendations
                setTimeout(() => {
                    updateGeneralRecommendations({
                        academic: [],
                        career: [],
                        skill_development: [],
                        risk_intervention: []
                    });
                }, 150);
            }
        }

        function updateBasicStats(stats) {
            document.getElementById('profileCompletion').textContent = stats.profile_completion + '%';
            document.getElementById('skillsMastered').textContent = stats.skills_mastered;
            document.getElementById('activeCourses').textContent = stats.active_courses;
            
            // Calculate recommended courses count
            let recommendedCount = 0;
            if (dashboardData.course_recommendations) {
                Object.values(dashboardData.course_recommendations).forEach(recommendation_data => {
                    if (recommendation_data && recommendation_data.recommendations) {
                        recommendedCount += recommendation_data.recommendations.length;
                    }
                });
            }
            document.getElementById('recommendedCourses').textContent = recommendedCount + ' recommended';
            
            // Update risk level - use dropout risk data if available
            const riskLevel = dashboardData.dropout_risk?.risk_level || 'Low';
            const riskElement = document.getElementById('riskLevel');
            if (riskElement) {
                riskElement.textContent = riskLevel;
            }
        }

        function updateEngagementMetrics(metrics) {
            document.getElementById('totalSessions').textContent = metrics.total_sessions || 0;
            document.getElementById('avgSessionDuration').textContent = 
                Math.round(metrics.avg_session_duration || 0) + 'm';
            document.getElementById('mostActiveHour').textContent = metrics.most_active_hour || 0;
            document.getElementById('mostActiveDay').textContent = metrics.most_active_day || '-';
        }

        function updateCharts(data) {
            console.log(' updateCharts called with data:', data);
            console.log(' Activities data:', data.activities);
            console.log(' Engagement metrics:', data.engagement_metrics);
            
            // Activity Timeline Chart
            const activityContainer = document.querySelector("#activityChart");
            console.log(' Activity Chart container found:', !!activityContainer);
            
            if (!charts.activityChart && activityContainer) {
                const timelineData = generateTimelineData(data.activities);
                console.log(' Generated timeline data:', timelineData);
                
                charts.activityChart = new ApexCharts(activityContainer, {
                    series: [{
                        name: 'Activities',
                        data: timelineData
                    }],
                    chart: {
                        type: 'area',
                        height: 300,
                        toolbar: { show: false }
                    },
                    colors: ['#4361ee'],
                    stroke: { curve: 'smooth', width: 3 },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.7,
                            opacityTo: 0.3
                        }
                    },
                    xaxis: {
                        categories: getLast7Days()
                    },
                    yaxis: {
                        title: { text: 'Activities' }
                    },
                    tooltip: {
                        x: { format: 'dd MMM yyyy' }
                    }
                });
                charts.activityChart.render();
                console.log(' Activity Chart rendered successfully');
            } else if (charts.activityChart) {
                // Update existing chart with new data
                const timelineData = generateTimelineData(data.activities);
                console.log(' Updating activity chart with new data:', timelineData);
                charts.activityChart.updateSeries([{
                    data: timelineData
                }]);
            }

            // Module Usage Chart
            const moduleContainer = document.querySelector("#moduleChart");
            console.log(' Module Chart container found:', !!moduleContainer);
            
            if (!charts.moduleChart && moduleContainer) {
                const moduleData = generateModuleData(data.engagement_metrics?.activity_breakdown || {});
                console.log(' Generated module data:', moduleData);
                
                charts.moduleChart = new ApexCharts(moduleContainer, {
                    series: [{
                        name: 'Usage',
                        data: moduleData
                    }],
                    chart: {
                        type: 'donut',
                        height: 300
                    },
                    colors: ['#4361ee', '#3f37c9', '#4cc9f0', '#4895ef', '#3a0ca3', '#7209b7'],
                    labels: ['Stream Assessment', 'Course Recommendations', 'Career Guidance', 'Quizzes', 'Risk Analysis', 'Other'],
                    plotOptions: {
                        pie: {
                            donut: {
                                size: '70%',
                                labels: {
                                    show: true,
                                    total: {
                                        show: true,
                                        label: 'Total Activities'
                                    }
                                }
                            }
                        }
                    },
                    tooltip: {
                        y: {
                            formatter: function(value) {
                                return value + ' activities';
                            }
                        }
                    }
                });
                charts.moduleChart.render();
                console.log(' Module Chart rendered successfully');
            } else if (charts.moduleChart) {
                // Update existing chart with new data
                const moduleData = generateModuleData(data.engagement_metrics?.activity_breakdown || {});
                console.log(' Updating module chart with new data:', moduleData);
                charts.moduleChart.updateSeries([{
                    data: moduleData
                }]);
            }

            // Weekly Activity Chart
            const weeklyContainer = document.querySelector("#weeklyChart");
            console.log(' Weekly Chart container found:', !!weeklyContainer);
            
            if (!charts.weeklyChart && weeklyContainer) {
                const weeklyData = generateWeeklyData(data.activities);
                console.log(' Generated weekly data:', weeklyData);
                
                charts.weeklyChart = new ApexCharts(weeklyContainer, {
                    series: [{
                        name: 'Daily Activities',
                        data: weeklyData
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        toolbar: { show: false }
                    },
                    colors: ['#4cc9f0'],
                    plotOptions: {
                        bar: {
                            borderRadius: 8,
                            columnWidth: '60%'
                        }
                    },
                    xaxis: {
                        categories: getLast7Days()
                    },
                    yaxis: {
                        title: { text: 'Activities Count' }
                    },
                    tooltip: {
                        y: {
                            formatter: function(value) {
                                return value + ' activities';
                            }
                        }
                    }
                });
                charts.weeklyChart.render();
                console.log(' Weekly Chart rendered successfully');
            } else if (charts.weeklyChart) {
                // Update existing chart with new data
                const weeklyData = generateWeeklyData(data.activities);
                console.log(' Updating weekly chart with new data:', weeklyData);
                charts.weeklyChart.updateSeries([{
                    data: weeklyData
                }]);
            }
        }

        function updateActivitiesUI(data) {
            const activitiesList = document.getElementById('activitiesList');
            const recentActivitiesList = document.getElementById('recentActivitiesList');
            
            if (activitiesList) {
                activitiesList.innerHTML = '';
                
                data.activities.forEach((activity, index) => {
                    const activityElement = document.createElement('div');
                    activityElement.className = 'timeline-activity';
                    activityElement.innerHTML = `
                        <div class="timeline-dot"></div>
                        <div class="activity-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="${activity.icon} me-2"></i>${activity.title}
                                    </h6>
                                    <p class="text-muted mb-1">${activity.description}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>${formatDate(activity.timestamp)}
                                    </small>
                                </div>
                                <span class="badge bg-primary">${activity.type}</span>
                            </div>
                        </div>
                    `;
                    activitiesList.appendChild(activityElement);
                });
            }

            // Also update recent activities on Overview tab (show only first 5)
            if (recentActivitiesList) {
                recentActivitiesList.innerHTML = '';
                
                const recentActivities = data.activities.slice(0, 5);
                if (recentActivities.length === 0) {
                    recentActivitiesList.innerHTML = '<p class="text-muted text-center">No recent activities found</p>';
                } else {
                    recentActivities.forEach((activity, index) => {
                        const activityElement = document.createElement('div');
                        activityElement.className = 'timeline-activity';
                        activityElement.innerHTML = `
                            <div class="timeline-dot"></div>
                            <div class="activity-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="${activity.icon} me-2"></i>${activity.title}
                                        </h6>
                                        <p class="text-muted mb-1">${activity.description}</p>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>${formatDate(activity.timestamp)}
                                        </small>
                                    </div>
                                    <span class="badge bg-primary">${activity.type}</span>
                                </div>
                            </div>
                        `;
                        recentActivitiesList.appendChild(activityElement);
                    });
                }
            }

            // Update activity breakdown chart
            updateActivityBreakdownChart(data.activity_stats);
        }

        function updateActivityBreakdownChart(stats) {
            if (!charts.activityBreakdownChart && Object.keys(stats).length > 0) {
                charts.activityBreakdownChart = new ApexCharts(document.querySelector("#activityBreakdownChart"), {
                    series: [{
                        name: 'Count',
                        data: Object.values(stats)
                    }],
                    chart: {
                        type: 'bar',
                        height: 300
                    },
                    colors: ['#4361ee'],
                    xaxis: {
                        categories: Object.keys(stats)
                    }
                });
                charts.activityBreakdownChart.render();
            }
        }

        function updateTrackingScores(scores) {
            console.log('Updating tracking scores:', scores);
            
            // Update statistics
            if (scores) {
                document.getElementById('highestScore').textContent = scores.highest || 0;
                document.getElementById('averageScore').textContent = scores.average || 0;
                document.getElementById('totalAssessments').textContent = scores.total || 0;
                document.getElementById('improvementRate').textContent = scores.improvement || '0%';
                
                // Debug quiz breakdown data
                console.log('Quiz breakdown data:', scores.quiz_breakdown);
                console.log('Quiz summary data:', scores.quiz_summary);
                console.log('Quiz breakdown keys:', scores.quiz_breakdown ? Object.keys(scores.quiz_breakdown) : 'None');
            }
            
            // Update score progress chart
            updateScoreProgressChart(scores);
            
            // Update quiz breakdown
            updateQuizBreakdown(scores);
            
            // Update score history list
            updateScoreHistoryList(scores);
        }
        
        function updateQuizBreakdown(scores) {
            const breakdownElement = document.getElementById('quizBreakdown');
            console.log('Quiz breakdown element found:', !!breakdownElement);
            
            if (!breakdownElement) return;
            
            try {
                breakdownElement.innerHTML = '';
                
                if (scores && scores.quiz_breakdown && Object.keys(scores.quiz_breakdown).length > 0) {
                    console.log('Processing quiz breakdown with data');
                    
                    // Try enhanced processing first
                    try {
                        // Group quizzes by category
                        const aptitudeQuizzes = [];
                        const subjectQuizzes = [];
                        
                        Object.entries(scores.quiz_breakdown).forEach(([quizType, stats]) => {
                            console.log(`Processing quiz: ${quizType}, category: ${stats.category}, count: ${stats.count}`);
                            
                            if (stats.category === 'Aptitude') {
                                aptitudeQuizzes.push([quizType, stats]);
                            } else if (stats.category === 'Subject') {
                                subjectQuizzes.push([quizType, stats]);
                            }
                        });
                        
                        console.log('Aptitude quizzes:', aptitudeQuizzes.length);
                        console.log('Subject quizzes:', subjectQuizzes.length);
                        
                        let breakdownHtml = '';
                        
                        // Aptitude Quizzes Section
                        if (aptitudeQuizzes.length > 0) {
                            breakdownHtml += `
                                <div class="mb-4">
                                    <h6 class="mb-3">
                                        <i class="fas fa-brain text-primary me-2"></i>
                                        Aptitude Quizzes
                                        <span class="badge bg-primary ms-2">${aptitudeQuizzes.length}</span>
                                    </h6>
                                    <div class="row">
                            `;
                            
                            aptitudeQuizzes.forEach(([quizType, stats]) => {
                                const icon = getQuizIcon(quizType);
                                const displayName = getQuizDisplayName(quizType);
                                const hasData = stats.count > 0;
                                
                                breakdownHtml += `
                                    <div class="col-md-4 mb-3">
                                        <div class="stat-card ${hasData ? 'border-primary' : 'border-secondary'}">
                                            <div class="stat-icon ${hasData ? 'primary' : 'secondary'}">
                                                <i class="${icon}"></i>
                                            </div>
                                            <h6 class="text-capitalize">${displayName}</h6>
                                            <small class="badge bg-${hasData ? 'info' : 'secondary'} mb-2">
                                                ${stats.category} Quiz
                                            </small>
                                            <div class="row text-center mt-2">
                                                <div class="col-4">
                                                    <small class="text-muted">Attempts</small>
                                                    <h5 class="mb-0">${stats.count}</h5>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Best</small>
                                                    <h5 class="mb-0 text-${hasData ? 'success' : 'muted'}">${stats.best_score}%</h5>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Average</small>
                                                    <h5 class="mb-0 text-${hasData ? 'primary' : 'muted'}">${stats.average_score}%</h5>
                                                </div>
                                            </div>
                                            ${stats.latest_score > 0 ? `
                                                <div class="mt-2 text-center">
                                                    <small class="text-muted">Latest: </small>
                                                    <span class="badge bg-warning">${stats.latest_score}%</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            breakdownHtml += `
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Subject Quizzes Section
                        if (subjectQuizzes.length > 0) {
                            breakdownHtml += `
                                <div class="mb-4">
                                    <h6 class="mb-3">
                                        <i class="fas fa-book text-success me-2"></i>
                                        Subject Quizzes
                                        <span class="badge bg-success ms-2">${subjectQuizzes.length}</span>
                                    </h6>
                                    <div class="row">
                            `;
                            
                            subjectQuizzes.forEach(([quizType, stats]) => {
                                const icon = getQuizIcon(quizType);
                                const displayName = getQuizDisplayName(quizType);
                                const hasData = stats.count > 0;
                                
                                breakdownHtml += `
                                    <div class="col-md-4 mb-3">
                                        <div class="stat-card ${hasData ? 'border-success' : 'border-secondary'}">
                                            <div class="stat-icon ${hasData ? 'success' : 'secondary'}">
                                                <i class="${icon}"></i>
                                            </div>
                                            <h6 class="text-capitalize">${displayName}</h6>
                                            <small class="badge bg-${hasData ? 'info' : 'secondary'} mb-2">
                                                ${stats.category} Quiz
                                            </small>
                                            <div class="row text-center mt-2">
                                                <div class="col-4">
                                                    <small class="text-muted">Attempts</small>
                                                    <h5 class="mb-0">${stats.count}</h5>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Best</small>
                                                    <h5 class="mb-0 text-${hasData ? 'success' : 'muted'}">${stats.best_score}%</h5>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Average</small>
                                                    <h5 class="mb-0 text-${hasData ? 'primary' : 'muted'}">${stats.average_score}%</h5>
                                                </div>
                                            </div>
                                            ${stats.latest_score > 0 ? `
                                                <div class="mt-2 text-center">
                                                    <small class="text-muted">Latest: </small>
                                                    <span class="badge bg-warning">${stats.latest_score}%</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            breakdownHtml += `
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Quiz Summary
                        if (scores.quiz_summary) {
                            breakdownHtml += `
                                <div class="mt-4 p-3 bg-light rounded">
                                    <h6 class="mb-3">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        Quiz Summary
                                    </h6>
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <small class="text-muted">Aptitude Taken</small>
                                            <h5 class="mb-0 text-primary">${scores.quiz_summary.aptitude_quizzes_taken}</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Subject Taken</small>
                                            <h5 class="mb-0 text-success">${scores.quiz_summary.subject_quizzes_taken}</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Best Aptitude</small>
                                            <h5 class="mb-0 text-info">${scores.quiz_summary.best_aptitude_score}%</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Best Subject</small>
                                            <h5 class="mb-0 text-warning">${scores.quiz_summary.best_subject_score}%</h5>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        breakdownElement.innerHTML = breakdownHtml;
                        
                    } catch (enhancedError) {
                        console.error('Enhanced quiz processing failed, using simple fallback:', enhancedError);
                        
                        // Simple fallback - just show basic quiz data
                        let simpleHtml = '<div class="row">';
                        Object.entries(scores.quiz_breakdown).forEach(([quizType, stats]) => {
                            if (stats.count > 0) {
                                simpleHtml += `
                                    <div class="col-md-4 mb-3">
                                        <div class="stat-card border-info">
                                            <div class="stat-icon info">
                                                <i class="fas fa-brain"></i>
                                            </div>
                                            <h6 class="text-capitalize">${quizType.replace('_', ' ')}</h6>
                                            <div class="row text-center mt-2">
                                                <div class="col-4">
                                                    <small class="text-muted">Attempts</small>
                                                    <h5 class="mb-0">${stats.count}</h5>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Best</small>
                                                    <h5 class="mb-0 text-success">${stats.best_score}%</h5>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Average</small>
                                                    <h5 class="mb-0 text-primary">${stats.average_score}%</h5>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        simpleHtml += '</div>';
                        
                        if (scores.quiz_summary) {
                            simpleHtml += `
                                <div class="mt-3 text-center">
                                    <span class="badge bg-info me-2">Total Quizzes: ${scores.quiz_summary.aptitude_quizzes_taken + scores.quiz_summary.subject_quizzes_taken}</span>
                                    <span class="badge bg-success">Best Score: ${Math.max(scores.quiz_summary.best_aptitude_score, scores.quiz_summary.best_subject_score)}%</span>
                                </div>
                            `;
                        }
                        
                        breakdownElement.innerHTML = simpleHtml;
                    }
                } else {
                    console.log('No quiz breakdown data available, showing fallback');
                    breakdownElement.innerHTML = '<p class="text-muted text-center">No quiz data available yet. Take some quizzes to see your performance breakdown!</p>';
                }
            } catch (error) {
                console.error('Error in updateQuizBreakdown:', error);
                breakdownElement.innerHTML = '<p class="text-danger text-center">Error loading quiz data. Please refresh the page.</p>';
            }
        }
        
        function getQuizIcon(quizType) {
            const icons = {
                'creativity': 'fas fa-palette',
                'logical': 'fas fa-brain',
                'analytical': 'fas fa-chart-line',
                'communication': 'fas fa-comments',
                'numerical': 'fas fa-calculator',
                'artistic': 'fas fa-paint-brush',
                'practical': 'fas fa-tools',
                'mathematics': 'fas fa-square-root-alt',
                'science': 'fas fa-flask',
                'biology': 'fas fa-dna',
                'english': 'fas fa-book',
                'social_studies': 'fas fa-globe',
                'language': 'fas fa-language'
            };
            return icons[quizType] || 'fas fa-question-circle';
        }
        
        function getQuizDisplayName(quizType) {
            const names = {
                'creativity': 'Creativity',
                'logical': 'Logical Reasoning',
                'analytical': 'Analytical',
                'communication': 'Communication',
                'numerical': 'Numerical Ability',
                'artistic': 'Artistic',
                'practical': 'Practical Skills',
                'mathematics': 'Mathematics',
                'science': 'Science',
                'biology': 'Biology',
                'english': 'English',
                'social_studies': 'Social Studies',
                'language': 'Language'
            };
            return names[quizType] || quizType.replace('_', ' ');
        }
        
        function updateScoreProgressChart(scores) {
            const options = {
                series: [{
                    name: 'Assessment Scores',
                    data: scores?.history || []
                }],
                chart: {
                    type: 'line',
                    height: 350,
                    toolbar: {
                        show: true
                    }
                },
                xaxis: {
                    categories: scores?.dates || [],
                    title: {
                        text: 'Assessment Date'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Score (%)'
                    },
                    min: 0,
                    max: 100
                },
                colors: ['#4361ee'],
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                markers: {
                    size: 6
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return value + '%';
                        }
                    }
                }
            };
            
            const chart = new ApexCharts(document.querySelector('#scoreProgressChart'), options);
            chart.render();
        }
        
        function updateScoreHistoryList(scores) {
            const historyList = document.getElementById('scoreHistoryList');
            if (!historyList) return;
            
            historyList.innerHTML = '';
            
            if (scores && scores.history && scores.history.length > 0) {
                scores.history.forEach((score, index) => {
                    const date = scores.dates[index] || 'Unknown';
                    const type = scores.types[index] || 'Assessment';
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'activity-item';
                    scoreItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${type}</h6>
                                <small class="text-muted">${date}</small>
                            </div>
                            <div class="text-end">
                                <h5 class="mb-0 ${score >= 70 ? 'text-success' : score >= 50 ? 'text-warning' : 'text-danger'}">${score}%</h5>
                            </div>
                        </div>
                    `;
                    historyList.appendChild(scoreItem);
                });
            } else {
                historyList.innerHTML = '<p class="text-muted text-center">No assessment scores available yet</p>';
            }
        }

        function updateRecommendations(courseRecommendations) {
            console.log('Updating recommendations with data:', courseRecommendations);
            
            // Update current stream courses
            updateCurrentStreamCourses(courseRecommendations);
            
            // Update all stream recommendations
            updateAllStreamRecommendations(courseRecommendations);
        }

        function updateCurrentStreamCourses(courseRecommendations) {
            const currentStreamElement = document.getElementById('currentStreamCourses');
            if (!currentStreamElement) {
                console.log('currentStreamCourses element not found');
                return;
            }

            currentStreamElement.innerHTML = '';
            
            console.log('Current stream courses data:', courseRecommendations);

            if (courseRecommendations && courseRecommendations.current_stream_recommendations) {
                const currentRecs = courseRecommendations.current_stream_recommendations;
                const stream = courseRecommendations.current_stream;
                
                console.log('Current stream:', stream);
                console.log('Current recommendations:', currentRecs);
                
                if (currentRecs.recommendations && currentRecs.recommendations.length > 0) {
                    console.log('Rendering course recommendations...');
                    currentStreamElement.innerHTML = `
                        <div class="col-12">
                            <div class="recommendation-card">
                                <h6 class="mb-3">
                                    <i class="fas fa-star me-2"></i>Best Course: ${currentRecs.best_course || 'N/A'}
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-2">Recommended Courses:</h6>
                                        <div class="list-group list-group-flush">
                                            ${currentRecs.recommendations.map(course => `
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <span>${course}</span>
                                                    <span class="badge bg-primary rounded-pill">Recommended</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-2">Career Options:</h6>
                                        <div class="list-group list-group-flush">
                                            ${currentRecs.careers.map(career => `
                                                <div class="list-group-item">
                                                    <i class="fas fa-briefcase me-2 text-success"></i>${career}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    console.log('Course recommendations rendered successfully');
                } else {
                    console.log('No recommendations found in currentRecs');
                    currentStreamElement.innerHTML = '<div class="col-12"><p class="text-muted">No course recommendations available.</p></div>';
                }
            } else {
                console.log('No current_stream_recommendations found');
                currentStreamElement.innerHTML = '<div class="col-12"><p class="text-muted">No stream recommendations available.</p></div>';
            }
        }

        function updateAllStreamRecommendations(courseRecommendations) {
            const allStreamsElement = document.getElementById('allStreamRecommendations');
            if (!allStreamsElement) return;

            allStreamsElement.innerHTML = '';

            if (courseRecommendations && courseRecommendations.all_stream_recommendations) {
                const allRecs = courseRecommendations.all_stream_recommendations;
                const streamIcons = {
                    'arts': 'fa-palette',
                    'commerce': 'fa-chart-line',
                    'pcm': 'fa-calculator',
                    'pcb': 'fa-microscope',
                    'vocational': 'fa-tools'
                };

                const streamColors = {
                    'arts': 'warning',
                    'commerce': 'success',
                    'pcm': 'primary',
                    'pcb': 'danger',
                    'vocational': 'info'
                };

                Object.entries(allRecs).forEach(([stream, recs]) => {
                    const isCurrentStream = stream === courseRecommendations.current_stream;
                    const icon = streamIcons[stream.toLowerCase()] || 'fa-book';
                    const color = streamColors[stream.toLowerCase()] || 'secondary';
                    
                    const streamCard = document.createElement('div');
                    streamCard.className = 'col-md-6 col-lg-4 mb-3';
                    streamCard.innerHTML = `
                        <div class="recommendation-card ${isCurrentStream ? 'border-primary' : ''}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas ${icon} me-2"></i>${stream.toUpperCase()}
                                </h6>
                                ${isCurrentStream ? '<span class="badge bg-primary">Current</span>' : ''}
                            </div>
                            <p class="text-muted small mb-2">Best: ${recs.best_course || 'N/A'}</p>
                            <div class="mb-2">
                                <small class="text-muted">Courses:</small>
                                <div class="d-flex flex-wrap gap-1 mt-1">
                                    ${(recs.recommendations || []).slice(0, 3).map(course => 
                                        `<span class="badge bg-light text-dark" style="font-size: 0.7rem;">${course}</span>`
                                    ).join('')}
                                    ${recs.recommendations && recs.recommendations.length > 3 ? 
                                        `<span class="badge bg-${color}" style="font-size: 0.7rem;">+${recs.recommendations.length - 3} more</span>` : ''}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${(recs.careers || []).length} career paths</small>
                                <button class="btn btn-sm btn-outline-${color}" onclick="exploreStream('${stream}')">
                                    View Details
                                </button>
                            </div>
                        </div>
                    `;
                    allStreamsElement.appendChild(streamCard);
                });

                // Add summary stats
                const summaryRow = document.createElement('div');
                summaryRow.className = 'col-12 mt-3';
                summaryRow.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        You have <strong>${courseRecommendations.total_courses || 0}</strong> course recommendations across 
                        <strong>${courseRecommendations.available_streams ? courseRecommendations.available_streams.length : 0}</strong> streams.
                    </div>
                `;
                allStreamsElement.appendChild(summaryRow);

            } else {
                allStreamsElement.innerHTML = `
                    <div class="col-12">
                        <div class="text-center text-muted">
                            <i class="fas fa-th-large fa-2x mb-2"></i>
                            <p>No recommendations available yet.</p>
                            <small>Complete assessments to unlock recommendations for all streams.</small>
                        </div>
                    </div>
                `;
            }
        }

        function updateGeneralRecommendations(recommendations) {
            console.log('Updating general recommendations:', recommendations);
            
            const recommendationsContainer = document.getElementById('generalRecommendations');
            if (!recommendationsContainer) {
                console.log('generalRecommendations container not found');
                return;
            }
            
            recommendationsContainer.innerHTML = '';
            
            const categories = [
                { key: 'academic', title: 'Academic Recommendations', icon: 'fas fa-graduation-cap', color: 'primary' },
                { key: 'career', title: 'Career Recommendations', icon: 'fas fa-briefcase', color: 'success' },
                { key: 'skill_development', title: 'Skill Development', icon: 'fas fa-tools', color: 'info' },
                { key: 'risk_intervention', title: 'Risk Intervention', icon: 'fas fa-exclamation-triangle', color: 'warning' }
            ];
            
            categories.forEach(category => {
                const categoryRecs = recommendations[category.key] || [];
                if (categoryRecs.length > 0) {
                    const categoryHtml = `
                        <div class="mb-4">
                            <h6 class="mb-3">
                                <i class="${category.icon} me-2 text-${category.color}"></i>${category.title}
                            </h6>
                            <div class="list-group">
                                ${categoryRecs.map(rec => `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">${rec.title}</h6>
                                                <p class="mb-2 text-muted small">${rec.description}</p>
                                                <span class="badge bg-${rec.priority === 'high' ? 'danger' : rec.priority === 'medium' ? 'warning' : 'secondary'} rounded-pill">
                                                    ${rec.priority} priority
                                                </span>
                                            </div>
                                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="handleRecommendationAction('${rec.action}', '${rec.type}')">
                                                ${rec.action}
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    recommendationsContainer.innerHTML += categoryHtml;
                }
            });
            
            if (recommendationsContainer.innerHTML === '') {
                // Check if course recommendations are available and show appropriate message
                setTimeout(() => {
                    const hasCourseRecommendations = document.getElementById('currentStreamCourses') && 
                                                    document.getElementById('currentStreamCourses').children.length > 0;
                    
                    if (hasCourseRecommendations) {
                        recommendationsContainer.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Course recommendations are available below!</strong>
                                <br>Check the "Courses for Your Stream" section for personalized course and career recommendations.
                                <br><small>Complete more assessments to unlock additional personalized recommendations.</small>
                            </div>
                        `;
                    } else {
                        recommendationsContainer.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-lightbulb fa-2x mb-2"></i>
                                <p>No recommendations available at the moment.</p>
                                <small>Complete assessments and activities to get personalized recommendations.</small>
                            </div>
                        `;
                    }
                }, 200); // Wait for course recommendations to load
            }
            
            console.log('General recommendations updated successfully');
        }

        function handleRecommendationAction(action, type) {
            console.log('Handling recommendation action:', action, type);
            
            // Handle different recommendation actions
            switch(type) {
                case 'stream_assessment':
                    window.location.href = '/training/';
                    break;
                case 'improve_skills':
                    window.location.href = '/quiz/';
                    break;
                case 'risk_assessment':
                    window.location.href = '/dropout-risk/';
                    break;
                default:
                    alert(`Action: ${action}\nThis would navigate to the appropriate page.`);
            }
        }

        function exploreCourse(course, stream) {
            // Track course exploration
            trackActivity('course_exploration', `Explored ${course} in ${stream}`, { course, stream });
            alert(`Exploring ${course} in ${stream} stream. This would typically open a detailed course view.`);
        }

        function exploreStream(stream) {
            // Track stream exploration
            trackActivity('stream_exploration', `Explored ${stream} stream`, { stream });
            alert(`Exploring ${stream} stream. This would typically show detailed stream information.`);
        }

        function createRecommendationSection(title, icon, items) {
            const section = document.createElement('div');
            section.className = 'mb-4';
            section.innerHTML = `
                <h6 class="mb-3"><i class="${icon} me-2"></i>${title}</h6>
            `;

            items.forEach(item => {
                const priorityClass = item.priority === 'high' ? 'danger' : item.priority === 'medium' ? 'warning' : 'info';
                const recommendationCard = document.createElement('div');
                recommendationCard.className = 'recommendation-card';
                recommendationCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${item.title}</h6>
                            <p class="text-muted mb-2">${item.description}</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="takeAction('${item.action}')">
                                ${item.action}
                            </button>
                        </div>
                        <span class="badge bg-${priorityClass}">${item.priority}</span>
                    </div>
                `;
                section.appendChild(recommendationCard);
            });

            return section;
        }

        function takeAction(action) {
            // Track the action
            trackActivity('recommendation_action', `Took action: ${action}`, { action: action });
            
            // Show feedback
            alert(`Action taken: ${action}`);
        }

        function trackActivity(type, title, data = {}) {
            fetch('/api/dashboard/activity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUserId,
                    type: type,
                    title: title,
                    description: title,
                    icon: 'fas fa-user',
                    data: data,
                    page: 'dashboard',
                    action: 'interaction'
                })
            });
        }

        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            const content = document.querySelector('.dashboard-container > .tab-content');
            
            if (show) {
                spinner.style.display = 'block';
                if (content) content.style.opacity = '0.5';
            } else {
                spinner.style.display = 'none';
                if (content) content.style.opacity = '1';
            }
        }

        function showError(message) {
            // Create or update error message element
            let errorElement = document.getElementById('errorMessage');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = 'errorMessage';
                errorElement.className = 'alert alert-danger';
                document.querySelector('.dashboard-container').prepend(errorElement);
            }
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        // Helper functions
        function generateTimelineData(activities) {
            // Generate timeline data from actual activities
            const timelineData = [];
            const last7Days = getLast7Days();
            
            // Initialize with 0 for each day
            last7Days.forEach(() => timelineData.push(0));
            
            // Count activities per day
            if (activities && activities.length > 0) {
                activities.forEach(activity => {
                    if (activity.timestamp) {
                        const activityDate = new Date(activity.timestamp);
                        const today = new Date();
                        const daysDiff = Math.floor((today - activityDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff < 7) {
                            timelineData[6 - daysDiff]++; // Reverse order for proper display
                        }
                    }
                });
            } else {
                // Generate sample data if no activities
                return [3, 5, 2, 8, 4, 6, 7];
            }
            
            return timelineData;
        }

        function generateModuleData(breakdown) {
            // Generate module usage data from activity breakdown
            if (breakdown && Object.keys(breakdown).length > 0) {
                return Object.values(breakdown);
            } else {
                // Generate sample module data based on typical usage
                return [15, 12, 8, 18, 6, 4]; // Stream Assessment, Course Recs, Career Guidance, Quizzes, Risk Analysis, Other
            }
        }

        function generateWeeklyData(activities) {
            // Generate weekly activity data
            const weeklyData = [];
            const last7Days = getLast7Days();
            
            // Initialize with 0 for each day
            last7Days.forEach(() => weeklyData.push(0));
            
            // Count activities per day
            if (activities && activities.length > 0) {
                activities.forEach(activity => {
                    if (activity.timestamp) {
                        const activityDate = new Date(activity.timestamp);
                        const today = new Date();
                        const daysDiff = Math.floor((today - activityDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff < 7) {
                            weeklyData[6 - daysDiff]++; // Reverse order for proper display
                        }
                    }
                });
            } else {
                // Generate sample data if no activities
                return [15, 22, 18, 28, 20, 25, 30];
            }
            
            return weeklyData;
        }

        function getLast7Days() {
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            }
            return days;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Load stream-based course recommendations
        function loadStreamCourses(stream) {
            const loadingElement = document.getElementById('courseLoading');
            const displayElement = document.getElementById('streamCourseDisplay');
            
            // Add loading animation to the selected button
            const buttons = document.querySelectorAll('.stream-btn');
            buttons.forEach(btn => btn.classList.remove('active', 'disabled'));
            const activeBtn = Array.from(buttons).find(btn => btn.onclick.toString().includes(`'${stream}'`));
            if (activeBtn) {
                activeBtn.classList.add('active', 'disabled');
            }
            
            // Fade out current content with animation
            if (displayElement.style.display !== 'none') {
                displayElement.style.opacity = '0';
                displayElement.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    // Show loading with animation
                    loadingElement.style.display = 'block';
                    loadingElement.style.opacity = '0';
                    loadingElement.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        loadingElement.style.opacity = '1';
                        loadingElement.style.transform = 'translateY(0)';
                    }, 100);
                    
                    displayElement.style.display = 'none';
                }, 300);
            } else {
                // Show loading immediately if no content is displayed
                loadingElement.style.display = 'block';
                loadingElement.style.opacity = '0';
                loadingElement.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    loadingElement.style.opacity = '1';
                    loadingElement.style.transform = 'translateY(0)';
                }, 100);
                
                displayElement.style.display = 'none';
            }
            
            console.log('Loading stream courses for:', stream);
            console.log('Dashboard data:', dashboardData);
            
            // Get stored course recommendations from dashboard data
            const storedRecommendations = getStoredCourseRecommendations(stream);
            
            console.log('Stored recommendations for', stream, ':', storedRecommendations);
            
            if (storedRecommendations) {
                // Simulate loading delay for better UX
                setTimeout(() => {
                    // Hide loading with animation
                    loadingElement.style.opacity = '0';
                    loadingElement.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        loadingElement.style.display = 'none';
                        
                        // Show content with animation
                        displayElement.style.display = 'block';
                        displayElement.style.opacity = '0';
                        displayElement.style.transform = 'translateY(20px)';
                        
                        console.log('Using stored recommendations for', stream, ':', storedRecommendations);
                        
                        // Handle different data formats
                        let courses = [];
                        let careers = [];
                        
                        if (storedRecommendations.recommendations) {
                            // Handle PCM-style recommendations (objects with course property)
                            if (Array.isArray(storedRecommendations.recommendations) && storedRecommendations.recommendations.length > 0 && 
                                typeof storedRecommendations.recommendations[0] === 'object') {
                                
                                // Add best course first if it exists
                                if (storedRecommendations.best_course) {
                                    const bestCourse = storedRecommendations.best_course;
                                    if (typeof bestCourse === 'object' && bestCourse !== null) {
                                        // Extract course name from object
                                        courses.push(bestCourse.course || bestCourse.Course || bestCourse.course_name || bestCourse.name || JSON.stringify(bestCourse));
                                    } else {
                                        courses.push(bestCourse);
                                    }
                                }
                                
                                // Handle different course property names (course vs Course)
                                const otherCourses = storedRecommendations.recommendations.map(rec => {
                                    // Handle different data formats
                                    if (typeof rec === 'object' && rec !== null) {
                                        // If it's an object, extract the course name
                                        return rec.course || rec.Course || rec['Course'] || rec.course_name || rec.name || JSON.stringify(rec);
                                    } else if (typeof rec === 'string') {
                                        // If it's already a string, use it directly
                                        return rec;
                                    } else {
                                        // For any other type, convert to string
                                        return String(rec);
                                    }
                                });
                                courses.push(...otherCourses);
                                
                                // Handle different career property names
                                const allCareers = storedRecommendations.recommendations.flatMap(rec => {
                                    if (typeof rec === 'object' && rec !== null) {
                                        // Handle different career property names and formats
                                        const careers = rec.careers || rec.career_options || rec['Career Options'] || rec['career_options'] || [];
                                        // If careers is a string, split by comma
                                        if (typeof careers === 'string') {
                                            return careers.split(',').map(c => c.trim()).filter(c => c);
                                        }
                                        // If careers is an array, return it as is
                                        if (Array.isArray(careers)) {
                                            return careers;
                                        }
                                        // If careers is anything else, convert to string and split
                                        if (careers) {
                                            return String(careers).split(',').map(c => c.trim()).filter(c => c);
                                        }
                                        return [];
                                    }
                                    return [];
                                });
                                careers.push(...allCareers);
                            } else {
                                courses = storedRecommendations.recommendations;
                            }
                        }
                        
                        if (storedRecommendations.careers) {
                            careers = storedRecommendations.careers;
                        }
                        
                        // Remove duplicates from careers and limit to 10
                        careers = [...new Set(careers)].slice(0, 10);
                        
                        console.log('Processed courses:', courses);
                        console.log('Processed careers:', careers);
                        
                        if (courses && courses.length > 0) {
                            displayStreamCourses(stream, courses, careers);
                            
                            // Animate the content entrance
                            setTimeout(() => {
                                displayElement.style.opacity = '1';
                                displayElement.style.transform = 'translateY(0)';
                            }, 100);
                        } else {
                            showError('No course recommendations available for this stream');
                            
                            // Animate error message
                            setTimeout(() => {
                                displayElement.style.opacity = '1';
                                displayElement.style.transform = 'translateY(0)';
                            }, 100);
                        }
                    }, 300);
                }, 800); // Simulated loading time
            } else {
                // Simulate loading delay then show error
                setTimeout(() => {
                    loadingElement.style.opacity = '0';
                    loadingElement.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        loadingElement.style.display = 'none';
                        displayElement.style.display = 'block';
                        displayElement.style.opacity = '0';
                        displayElement.style.transform = 'translateY(20px)';
                        
                        showError(`No stored course recommendations found for ${stream.toUpperCase()}. Please take the ${stream.toUpperCase()} assessment first.`);
                        
                        // Animate error message
                        setTimeout(() => {
                            displayElement.style.opacity = '1';
                            displayElement.style.transform = 'translateY(0)';
                        }, 100);
                    }, 300);
                }, 800);
            }
            
            // Remove active state from button after loading
            setTimeout(() => {
                buttons.forEach(btn => btn.classList.remove('active', 'disabled'));
            }, 1200);
        }
        
        // Get stored course recommendations from dashboard data
        function getStoredCourseRecommendations(stream) {
            console.log('Getting stored recommendations for stream:', stream);
            
            if (!dashboardData) {
                console.log('No dashboard data available');
                return null;
            }
            
            if (!dashboardData.course_recommendations) {
                console.log('No course recommendations in dashboard data');
                console.log('Available dashboard data keys:', Object.keys(dashboardData));
                return null;
            }
            
            const courseRecs = dashboardData.course_recommendations;
            console.log('Course recommendations data:', courseRecs);
            
            // Check all stream recommendations
            if (courseRecs.all_stream_recommendations) {
                console.log('All stream recommendations:', courseRecs.all_stream_recommendations);
                console.log('Available streams in recommendations:', Object.keys(courseRecs.all_stream_recommendations));
                
                if (courseRecs.all_stream_recommendations[stream]) {
                    console.log('Found recommendations for', stream, ':', courseRecs.all_stream_recommendations[stream]);
                    return courseRecs.all_stream_recommendations[stream];
                } else {
                    console.log('No recommendations found for stream:', stream);
                }
            } else {
                console.log('No all_stream_recommendations found');
            }
            
            return null;
        }
        
        function displayStreamCourses(stream, courses, careers) {
            const displayElement = document.getElementById('streamCourseDisplay');
            
            const streamColors = {
                'arts': 'primary',
                'commerce': 'success',
                'pcm': 'primary',
                'pcb': 'danger',
                'vocational': 'info'
            };
            
            const streamIcons = {
                'arts': 'fa-palette',
                'commerce': 'fa-coins',
                'pcm': 'fa-flask',
                'pcb': 'fa-microscope',
                'vocational': 'fa-tools'
            };
            
            const color = streamColors[stream] || 'secondary';
            const icon = streamIcons[stream] || 'fa-graduation-cap';
            
            displayElement.innerHTML = `
                <div class="recommendation-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">
                            <i class="fas ${icon} me-2"></i>${stream.toUpperCase()} Stream Courses
                        </h5>
                        <span class="badge bg-${color} course-badge">${courses.length} Courses</span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-book me-2"></i>Recommended Courses:
                            </h6>
                            <div class="list-group list-group-flush">
                                ${courses.map((course, index) => `
                                    <div class="list-group-item d-flex justify-content-between align-items-center course-item" style="animation-delay: ${index * 0.1}s;">
                                        <div>
                                            <strong>${index + 1}. ${course}</strong>
                                        </div>
                                        <button class="btn btn-sm btn-outline-${color} course-explore-btn" onclick="exploreCourse('${course}', '${stream}')">
                                            Explore
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-briefcase me-2"></i>Career Paths:
                            </h6>
                            <div class="list-group list-group-flush">
                                ${careers.slice(0, 5).map((career, index) => `
                                    <div class="list-group-item career-path-item" style="animation-delay: ${index * 0.15}s;">
                                        <i class="fas fa-rocket me-2 text-muted"></i>${career}
                                    </div>
                                `).join('')}
                                ${careers.length > 5 ? `
                                    <div class="list-group-item text-muted career-path-item" style="animation-delay: 0.75s;">
                                        <small>+${careers.length - 5} more career paths</small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-${color} detailed-analysis-btn" onclick="getDetailedRecommendations('${stream}')">
                            <i class="fas fa-search me-2"></i>Get Detailed Analysis
                        </button>
                    </div>
                </div>
            `;
            
            // Add entrance animation to course items
            setTimeout(() => {
                const courseItems = displayElement.querySelectorAll('.course-item');
                const careerItems = displayElement.querySelectorAll('.career-path-item');
                
                courseItems.forEach((item, index) => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateX(0)';
                });
                
                careerItems.forEach((item, index) => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateX(0)';
                });
            }, 100);
        }
        
        function showError(message) {
            const displayElement = document.getElementById('streamCourseDisplay');
            displayElement.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }

        // Get user's actual PCM assessment data if available, otherwise use default
        function getPCMUserProfile(stream) {
            // Try to get user's actual assessment data from dashboard
            if (dashboardData && dashboardData.stream_recommendation && dashboardData.stream_recommendation.scores) {
                const userScores = dashboardData.stream_recommendation.scores;
                console.log('Using actual user scores:', userScores);
                
                // Map the user scores to PCM format
                return {
                    physics: userScores.physics || userScores.science || 75,
                    chemistry: userScores.chemistry || userScores.science || 70,
                    mathematics: userScores.math || userScores.mathematics || 80,
                    computer_science: userScores.computer_science || 72,
                    statistics: userScores.statistics || 68,
                    engineering_graphics: userScores.engineering_graphics || 65,
                    english: userScores.english || 70,
                    physical_education: userScores.physical_education || 60,
                    interest_science: userScores.interest_science || 85,
                    interest_technology: userScores.interest_technology || 78,
                    interest_engineering: userScores.interest_engineering || 82,
                    logical_reasoning: userScores.logical_reasoning || 75,
                    analytical_ability: userScores.analytical_ability || 72,
                    numerical_ability: userScores.numerical_ability || userScores.numerical || 78,
                    problem_solving: userScores.problem_solving || 70
                };
            }
            
            // Fallback to default profile
            console.log('Using default PCM profile');
            return getDefaultProfile(stream);
        }
        function getDefaultProfile(stream) {
            const defaultProfiles = {
                'arts': {
                    history: 70, political_science: 75, geography: 65, economics: 60,
                    sociology: 70, psychology: 72, philosophy: 68, languages: 75,
                    fine_arts: 80, music: 70, drama: 65, creative_writing: 72,
                    logical_reasoning: 65, memory: 70, verbal_ability: 75, analytical_ability: 68
                },
                'commerce': {
                    accountancy: 75, business_studies: 80, economics: 70, mathematics: 65,
                    statistics: 68, business_mathematics: 70, english: 75, computer_applications: 72,
                    entrepreneurship: 78, marketing: 73, finance: 76, management: 74,
                    numerical_aptitude: 75, communication: 72, logical_reasoning: 70, analytical_ability: 68
                },
                'pcm': {
                    physics: 75, chemistry: 70, mathematics: 80, computer_science: 72,
                    statistics: 68, engineering_graphics: 65, english: 70, physical_education: 60,
                    interest_science: 85, interest_technology: 78, interest_engineering: 82,
                    logical_reasoning: 75, analytical_ability: 72, numerical_ability: 78, problem_solving: 70
                },
                'pcb': {
                    physics: 70, chemistry: 72, biology: 80, mathematics: 65,
                    english: 68, hindi: 60, psychology: 70, computer_science: 65,
                    logical_reasoning: 68, analytical_thinking: 72, critical_thinking: 70, problem_solving: 68,
                    communication: 65, creativity: 70, research_skills: 75, numerical_aptitude: 64,
                    empathy: 78, attention_to_detail: 72
                },
                'vocational': {
                    fine_arts: 75, computer_science: 70, business_studies: 65,
                    creativity: 80, communication: 72, empathy: 68, logical_reasoning: 65,
                    critical_thinking: 70, numerical_aptitude: 62, english: 70,
                    sociology: 65, psychology: 68, geography: 60, biology: 62, chemistry: 58
                }
            };
            
            return defaultProfiles[stream] || {};
        }
        
        function getDetailedRecommendations(stream) {
            // This could open a modal or navigate to detailed analysis
            alert(`Detailed analysis for ${stream} stream would be implemented here.`);
        }
        
        // Career Paths Functions
        function updateCareerPaths(careerData) {
            console.log('=== updateCareerPaths called ===');
            console.log('careerData:', careerData);
            
            if (!careerData) {
                console.log('No career data available');
                return;
            }
            
            console.log('Updating career paths with data:', careerData);
            
            // Handle both old and new data formats
            let assessmentData = null;
            let careerPaths = [];
            let stream = '';
            
            if (careerData.has_data === false) {
                console.log('No career data available (has_data=false)');
                displayNoCareerData(careerData.message || 'No career assessment found');
                return;
            }
            
            // Extract assessment data
            if (careerData.assessment) {
                console.log('Found assessment data');
                assessmentData = careerData.assessment;
                stream = careerData.stream || assessmentData.stream || '';
                careerPaths = careerData.career_paths || [];
                console.log('Stream:', stream);
                console.log('Recommendations count:', assessmentData.recommendations ? assessmentData.recommendations.length : 0);
            } else if (careerData.assessment && careerData.assessment.recommendations) {
                // Legacy format
                console.log('Found legacy format');
                assessmentData = careerData.assessment;
                careerPaths = careerData.career_paths || [];
            }
            
            if (!assessmentData) {
                console.log('No assessment data found in career data');
                displayNoCareerData('No assessment data available');
                return;
            }
            
            console.log('About to update career assessment summary...');
            // Update career assessment summary
            updateCareerAssessmentSummary(assessmentData, stream);
            
            console.log('About to update career compatibility chart...');
            // Update career compatibility chart
            updateCareerCompatibilityChart(assessmentData);
            
            console.log('About to update career paths list...');
            // Update career paths list
            updateCareerPathsList(assessmentData, careerPaths);
            
            console.log('About to update skills radar chart...');
            // Update skills radar chart
            updateSkillsRadarChart(assessmentData);
            
            console.log('About to update suggested courses...');
            // Update suggested courses
            updateSuggestedCourses(assessmentData);
            
            console.log('=== updateCareerPaths completed ===');
        }
        
        function displayNoCareerData(message) {
            // Update all career-related sections with no data message
            const summaryElement = document.getElementById('careerAssessmentSummary');
            if (summaryElement) {
                summaryElement.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        ${message}
                    </div>
                `;
            }
            
            const chartElement = document.getElementById('careerCompatibilityChart');
            if (chartElement) {
                chartElement.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-chart-bar me-2"></i>
                        No career compatibility data available
                    </div>
                `;
            }
            
            const listElement = document.getElementById('careerPathsList');
            if (listElement) {
                listElement.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-briefcase me-2"></i>
                        No career paths available. 
                        <button class="btn btn-primary btn-sm mt-2" onclick="goToCareerAssessment()">
                            <i class="fas fa-clipboard-list me-1"></i>Take Career Assessment
                        </button>
                    </div>
                `;
            }
        }
        
        function updateCareerAssessmentSummary(assessmentData, stream) {
            console.log('=== updateCareerAssessmentSummary called ===');
            console.log('assessmentData:', assessmentData);
            console.log('stream:', stream);
            
            const summaryElement = document.getElementById('careerAssessmentSummary');
            console.log('summaryElement found:', !!summaryElement);
            
            if (!summaryElement) return;
            
            if (assessmentData) {
                const streamName = stream || assessmentData.stream || 'Not specified';
                const scores = assessmentData.scores || {};
                
                // Scores are already in 0-10 range from backend
                const scoreValues = Object.values(scores);
                const avgScore = scoreValues.length > 0 ? 
                    (scoreValues.reduce((a, b) => a + b, 0) / scoreValues.length).toFixed(1) : 0;
                
                // Get top skills with original scores
                const topSkills = Object.entries(scores)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([skill, score]) => ({ skill, score }));
                
                // Get recommendations count
                const recommendations = assessmentData.recommendations || [];
                const topRecommendations = recommendations.slice(0, 3);
                
                summaryElement.innerHTML = `
                    <div class="mb-3">
                        <h6 class="text-primary"><i class="fas fa-user-graduate me-2"></i>Stream: ${streamName}</h6>
                        <div class="mb-2">
                            <span class="badge bg-success">Overall Score: ${avgScore}/10</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted">Top Skills:</h6>
                        ${topSkills.map(skill => `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">${skill.skill}</small>
                                <div class="progress" style="height: 6px; width: 100px;">
                                    <div class="progress-bar bg-primary" style="width: ${skill.score * 10}%"></div>
                                </div>
                                <small class="text-muted ms-2">${skill.score.toFixed(1)}/10</small>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-muted">Top Career Matches:</h6>
                        <div class="list-group list-group-flush">
                            ${topRecommendations.map((career, index) => `
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small>
                                            <span class="badge bg-primary me-1">#${index + 1}</span>
                                            ${career.title}
                                        </small>
                                        <small class="text-success">${career.compatibility_score}%</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Assessment completed: ${new Date(assessmentData.timestamp || assessmentData.created_at).toLocaleDateString()}
                        </small>
                    </div>
                `;
            } else {
                summaryElement.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-compass fa-3x mb-3"></i>
                        <p>No career assessment data available.<br>
                        <button class="btn btn-primary btn-sm mt-2" onclick="goToCareerAssessment()">
                            <i class="fas fa-clipboard-list me-1"></i>Take Career Assessment
                        </button></p>
                    </div>
                `;
            }
        }
        
        function updateCareerCompatibilityChart(assessmentData) {
            const chartElement = document.getElementById('careerCompatibilityChart');
            if (!chartElement) return;
            
            if (assessmentData && assessmentData.recommendations) {
                const recommendations = assessmentData.recommendations.slice(0, 10); // Top 10 careers
                
                const options = {
                    series: [{
                        name: 'Compatibility Score',
                        data: recommendations.map(r => r.compatibility_score || 0)
                    }],
                    chart: {
                        type: 'bar',
                        height: 350,
                        toolbar: {
                            show: true
                        }
                    },
                    plotOptions: {
                        bar: {
                            horizontal: true,
                            borderRadius: 4,
                            dataLabels: {
                                position: 'right'
                            }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function(value) {
                            return value + '%';
                        },
                        offsetX: 10
                    },
                    xaxis: {
                        categories: recommendations.map(r => r.title),
                        title: {
                            text: 'Compatibility Score (%)'
                        },
                        max: 100
                    },
                    yaxis: {
                        title: {
                            text: 'Career Paths'
                        }
                    },
                    colors: ['#00d084'],
                    tooltip: {
                        y: {
                            formatter: function(value) {
                                return value + '% compatible';
                            }
                        }
                    }
                };
                
                new ApexCharts(chartElement, options).render();
            } else {
                chartElement.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>No career compatibility data available.<br>
                        Complete a career assessment to see your compatibility scores.</p>
                    </div>
                `;
            }
        }
        
        function updateCareerPathsList(assessmentData, careerPaths) {
            const listElement = document.getElementById('careerPathsList');
            if (!listElement) return;
            
            if (assessmentData && assessmentData.recommendations) {
                const recommendations = assessmentData.recommendations.slice(0, 5); // Top 5 careers
                
                listElement.innerHTML = recommendations.map((career, index) => `
                    <div class="career-path-card animate-fade-in" style="animation-delay: ${index * 0.1}s">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <div class="career-score-badge">
                                                ${Math.round(career.compatibility_score)}% Match
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-0 fw-bold">${career.title}</h6>
                                            <small class="text-muted">${career.type}</small>
                                        </div>
                                    </div>
                                    <div class="career-compatibility-bar">
                                        <div class="career-compatibility-fill" style="width: 0%" data-width="${career.compatibility_score}%"></div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                            ${career.skills.slice(0, 4).map(skill => 
                                                `<span class="badge bg-light text-dark me-1">${skill}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-outline-primary btn-sm career-explore-btn" onclick="exploreCareer('${career.title}')">
                                        <i class="fas fa-search me-1"></i>Explore
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Animate compatibility bars after DOM update
                setTimeout(() => {
                    document.querySelectorAll('.career-compatibility-fill').forEach(bar => {
                        const width = bar.getAttribute('data-width');
                        bar.style.width = width;
                    });
                }, 100);
                
            } else {
                listElement.innerHTML = `
                    <div class="career-empty-state">
                        <i class="fas fa-briefcase"></i>
                        <h5>No career paths available</h5>
                        <p>Complete your career assessment to discover personalized career recommendations</p>
                        <button class="btn btn-primary btn-lg career-assessment-btn" onclick="goToCareerAssessment()">
                            <i class="fas fa-clipboard-list me-2"></i>
                            <span>Take Career Assessment</span>
                            <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                `;
            }
        }
        
        function updateSkillsRadarChart(assessmentData) {
            const chartElement = document.getElementById('skillsRadarChart');
            if (!chartElement) return;
            
            if (assessmentData && assessmentData.scores) {
                const scores = assessmentData.scores;
                
                // Scores are already in 0-10 range from backend
                const options = {
                    series: [{
                        name: 'Your Skills',
                        data: Object.values(scores)
                    }],
                    chart: {
                        type: 'radar',
                        height: 350
                    },
                    dataLabels: {
                        enabled: true
                    },
                    plotOptions: {
                        radar: {
                            size: 120,
                            polygons: {
                                strokeColors: '#e9ecef',
                                fill: {
                                    colors: ['#f8f9fa', '#ffffff']
                                }
                            }
                        }
                    },
                    xaxis: {
                        categories: Object.keys(scores)
                    },
                    yaxis: {
                        stepSize: 2,
                        min: 0,
                        max: 10
                    },
                    colors: ['#4361ee'],
                    markers: {
                        size: 4,
                        colors: ['#fff'],
                        strokeColor: '#4361ee',
                        strokeWidth: 2
                    },
                    tooltip: {
                        y: {
                            formatter: function(value) {
                                return value + '%';
                            }
                        }
                    }
                };
                
                new ApexCharts(chartElement, options).render();
            } else {
                chartElement.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-radar fa-3x mb-3"></i>
                        <p>No skills data available.<br>
                        Complete a career assessment to see your skills analysis.</p>
                    </div>
                `;
            }
        }
        
        function updateSuggestedCourses(assessmentData) {
            const coursesElement = document.getElementById('suggestedCoursesList');
            if (!coursesElement) return;
            
            if (assessmentData && assessmentData.recommendations) {
                // Collect all courses from top career recommendations
                const allCourses = new Set();
                assessmentData.recommendations.slice(0, 3).forEach(career => {
                    if (career.courses) {
                        career.courses.forEach(course => allCourses.add(course));
                    }
                });
                
                const coursesArray = Array.from(allCourses).slice(0, 8); // Limit to 8 courses
                
                coursesElement.innerHTML = coursesArray.map((course, index) => `
                    <div class="course-item animate-fade-in" style="animation-delay: ${index * 0.1}s">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="stat-icon primary" style="width: 40px; height: 40px; font-size: 16px;">
                                            <i class="fas fa-graduation-cap"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-semibold">${course}</h6>
                                        <small class="text-muted">Recommended based on your career profile</small>
                                    </div>
                                </div>
                            </div>
                            <button class="btn course-explore-btn" onclick="exploreCourse('${course}')">
                                <i class="fas fa-arrow-right me-1"></i>Explore
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                coursesElement.innerHTML = `
                    <div class="career-empty-state">
                        <i class="fas fa-graduation-cap"></i>
                        <h5>No course suggestions available</h5>
                        <p>Complete your career assessment to get personalized course recommendations</p>
                        <button class="btn btn-primary career-assessment-btn" onclick="goToCareerAssessment()">
                            <i class="fas fa-clipboard-list me-2"></i>
                            <span>Take Career Assessment</span>
                            <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                `;
            }
        }
        
        function exploreCareer(careerTitle) {
            // Track career exploration
            trackActivity('career_exploration', `Explored career: ${careerTitle}`, { career: careerTitle });
            
            // Open career details or navigate to career page
            alert(`Exploring career: ${careerTitle}\n\nThis would open detailed career information including:\n- Job description\n- Salary range\n- Required skills\n- Career progression\n- Related courses`);
        }
        
        function viewCareerDetails(careerTitle) {
            // Track career detail view
            trackActivity('career_details', `Viewed career details: ${careerTitle}`, { career: careerTitle });
            
            // Open detailed career information
            alert(`Career Details: ${careerTitle}\n\nThis would show comprehensive information about the career path.`);
        }

        // Career Assessment Navigation
        function goToCareerAssessment() {
            // Get current user ID and pass it as URL parameter
            const userId = currentUserId || localStorage.getItem('dashboard_user_id') || 'anonymous';
            
            // Track the action
            trackActivity('career_assessment_start', 'Started career assessment from dashboard', { 
                user_id: userId,
                source: 'dashboard_career_tab'
            });
            
            // Navigate to career assessment page (same server)
            window.location.href = `/career_mapping?user_id=${userId}`;
        }
        function startRiskAssessment() {
            // Get current user ID and pass it as URL parameter
            const userId = currentUserId || localStorage.getItem('dashboard_user_id') || 'anonymous';
            window.location.href = `/dropout-risk?user_id=${userId}`;
        }

        function updateRiskDisplay(riskData) {
            if (!riskData) return;

            // Update risk score
            const riskScore = riskData.risk_score || 0;
            const riskLevel = riskData.risk_level || 'Unknown';
            
            document.getElementById('riskPercentage').textContent = riskScore + '%';
            document.getElementById('riskLevel').textContent = riskLevel;
            
            // Update risk level color
            const riskLevelElement = document.getElementById('riskLevel');
            riskLevelElement.className = '';
            
            if (riskScore >= 70) {
                riskLevelElement.classList.add('text-danger');
                document.getElementById('riskDescription').textContent = 'High risk factors detected. Immediate intervention recommended.';
            } else if (riskScore >= 30) {
                riskLevelElement.classList.add('text-warning');
                document.getElementById('riskDescription').textContent = 'This student shows some risk factors. Monitoring and support are recommended.';
            } else {
                riskLevelElement.classList.add('text-success');
                document.getElementById('riskDescription').textContent = 'Low risk factors. Continue current academic strategies.';
            }

            // Update risk breakdown
            if (riskData.factors) {
                updateRiskBreakdown(riskData.factors);
            }

            // Update recommendations
            updateRecommendations(riskLevel, riskScore);
        }

        function updateRiskBreakdown(factors) {
            const breakdown = [
                { name: 'Academic', value: factors.academic || 0, color: 'primary', icon: 'fa-graduation-cap', description: 'Academic performance indicators' },
                { name: 'Behavioral', value: factors.behavioral || 0, color: 'info', icon: 'fa-user-friends', description: 'Behavioral patterns and engagement' },
                { name: 'Personal', value: factors.personal || 0, color: 'warning', icon: 'fa-user', description: 'Personal circumstances and wellbeing' },
                { name: 'Institutional', value: factors.institutional || 0, color: 'success', icon: 'fa-school', description: 'Institutional factors and support' },
                { name: 'Social', value: factors.social || 0, color: 'secondary', icon: 'fa-users', description: 'Social connections and networks' },
                { name: 'External', value: factors.external || 0, color: 'dark', icon: 'fa-globe', description: 'External environmental factors' },
                { name: 'Psychological', value: factors.psychological || 0, color: 'danger', icon: 'fa-brain', description: 'Psychological wellbeing factors' },
                { name: 'Historical', value: factors.historical || 0, color: 'light', icon: 'fa-history', description: 'Historical academic patterns' }
            ];

            const breakdownHtml = breakdown.map((factor, index) => {
                const displayValue = Math.abs(factor.value);
                const riskLevel = displayValue > 50 ? 'high' : displayValue > 25 ? 'medium' : 'low';
                const animationDelay = index * 100; // Stagger animations
                
                return `
                    <div class="risk-factor-item mb-3 animate-slide-in" style="animation-delay: ${animationDelay}ms; opacity: 1;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <div class="risk-icon me-2">
                                    <i class="fas ${factor.icon} text-${factor.color}"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-semibold">${factor.name}</h6>
                                    <small class="text-muted">${factor.description}</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${factor.color} risk-value-badge" data-value="${displayValue}">
                                    ${displayValue.toFixed(1)}%
                                </span>
                                <div class="risk-indicator mt-1">
                                    <span class="badge bg-${riskLevel === 'high' ? 'danger' : riskLevel === 'medium' ? 'warning' : 'success'} badge-sm">
                                        ${riskLevel}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="progress risk-progress" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-${factor.color} risk-progress-bar" 
                                 style="width: 0%;" 
                                 data-target="${displayValue}%">
                                <span class="sr-only">${displayValue}% ${factor.name}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('riskBreakdown').innerHTML = `
                <div class="risk-analysis-container">
                    <div class="text-center mb-4">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-chart-line me-2"></i>
                            Risk Factor Distribution Analysis
                        </h6>
                        <p class="text-muted small mb-0">
                            Comprehensive breakdown of all contributing factors to the overall risk assessment
                        </p>
                    </div>
                    ${breakdownHtml}
                </div>
            `;

            // Animate progress bars after DOM update
            setTimeout(() => {
                const progressBars = document.querySelectorAll('.risk-progress-bar');
                progressBars.forEach((bar, index) => {
                    setTimeout(() => {
                        const targetWidth = bar.getAttribute('data-target');
                        bar.style.width = targetWidth;
                        bar.style.transition = 'width 1.5s ease-out';
                        
                        // Animate the value counter
                        const valueBadge = bar.closest('.risk-factor-item').querySelector('.risk-value-badge');
                        if (valueBadge) {
                            const targetValue = parseFloat(valueBadge.getAttribute('data-value'));
                            animateValue(valueBadge, 0, targetValue, 1500);
                        }
                    }, index * 100);
                });

                // Fade in the items
                const items = document.querySelectorAll('.animate-slide-in');
                items.forEach((item, index) => {
                    setTimeout(() => {
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                        item.style.transition = 'all 0.6s ease-out';
                    }, index * 100);
                });
            }, 100);
        }

        // Function to animate numeric values
        function animateValue(element, start, end, duration) {
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const currentValue = start + (end - start) * easeOutQuad(progress);
                element.textContent = currentValue.toFixed(1) + '%';
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // Easing function for smooth animation
        function easeOutQuad(t) {
            return t * (2 - t);
        }

        function updateRecommendations(riskLevel, riskScore) {
            let recommendations = '';

            if (riskScore >= 70) {
                recommendations = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Critical Actions Required</h6>
                        <ul class="mb-0">
                            <li>Immediate academic counseling session</li>
                            <li>Comprehensive support plan development</li>
                            <li>Weekly progress monitoring</li>
                            <li>Consider temporary course load reduction</li>
                        </ul>
                    </div>
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-info-circle me-2"></i>Support Resources</h6>
                        <ul class="mb-0">
                            <li>Connect with student support services</li>
                            <li>Peer mentoring program</li>
                            <li>Financial aid consultation</li>
                        </ul>
                    </div>
                `;
            } else if (riskScore >= 30) {
                recommendations = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Recommended Actions</h6>
                        <ul class="mb-0">
                            <li>Schedule academic counseling session</li>
                            <li>Review study habits and time management</li>
                            <li>Consider tutoring support for challenging subjects</li>
                        </ul>
                    </div>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Long-term Strategies</h6>
                        <ul class="mb-0">
                            <li>Develop consistent study schedule</li>
                            <li>Join study groups for peer support</li>
                            <li>Regular check-ins with academic advisor</li>
                        </ul>
                    </div>
                `;
            } else {
                recommendations = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Maintain Current Progress</h6>
                        <ul class="mb-0">
                            <li>Continue effective study habits</li>
                            <li>Maintain regular class attendance</li>
                            <li>Stay engaged with campus activities</li>
                        </ul>
                    </div>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>Growth Opportunities</h6>
                        <ul class="mb-0">
                            <li>Explore advanced course options</li>
                            <li>Consider leadership roles in activities</li>
                            <li>Mentor other students</li>
                        </ul>
                    </div>
                `;
            }

            document.getElementById('riskRecommendations').innerHTML = recommendations;
        }

        function updateFormDataDisplay(formData) {
            if (!formData) {
                document.getElementById('formDataDisplay').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                        <p>No form data available.</p>
                    </div>
                `;
                return;
            }

            // Group form data by categories
            const categories = {
                'Academic Performance': {
                    icon: 'fa-graduation-cap',
                    fields: ['grades', 'attendance', 'assignments', 'exams'],
                    labels: {
                        grades: 'Grades',
                        attendance: 'Attendance',
                        assignments: 'Assignments',
                        exams: 'Exams'
                    }
                },
                'Behavioral Indicators': {
                    icon: 'fa-user-friends',
                    fields: ['participation', 'absences', 'tardiness', 'behavioral_issues'],
                    labels: {
                        participation: 'Participation',
                        absences: 'Absences',
                        tardiness: 'Tardiness',
                        behavioral_issues: 'Behavioral Issues'
                    }
                },
                'Personal Factors': {
                    icon: 'fa-user',
                    fields: ['financial_stress', 'work_hours', 'family_support', 'health_status'],
                    labels: {
                        financial_stress: 'Financial Stress',
                        work_hours: 'Work Hours',
                        family_support: 'Family Support',
                        health_status: 'Health Status'
                    }
                },
                'Institutional Factors': {
                    icon: 'fa-school',
                    fields: ['course_load', 'major_fit', 'faculty_interaction', 'campus_involvement'],
                    labels: {
                        course_load: 'Course Load',
                        major_fit: 'Major Fit',
                        faculty_interaction: 'Faculty Interaction',
                        campus_involvement: 'Campus Involvement'
                    }
                },
                'Social Factors': {
                    icon: 'fa-users',
                    fields: ['peer_network', 'mentorship', 'bullying'],
                    labels: {
                        peer_network: 'Peer Network',
                        mentorship: 'Mentorship',
                        bullying: 'Bullying'
                    }
                },
                'External Factors': {
                    icon: 'fa-globe',
                    fields: ['commute_time', 'family_responsibilities', 'work_life_balance'],
                    labels: {
                        commute_time: 'Commute Time',
                        family_responsibilities: 'Family Responsibilities',
                        work_life_balance: 'Work-Life Balance'
                    }
                },
                'Psychological Factors': {
                    icon: 'fa-brain',
                    fields: ['motivation', 'self_efficacy', 'stress_level'],
                    labels: {
                        motivation: 'Motivation',
                        self_efficacy: 'Self Efficacy',
                        stress_level: 'Stress Level'
                    }
                },
                'Historical Data': {
                    icon: 'fa-history',
                    fields: ['previous_dropout', 'grade_retention', 'school_changes'],
                    labels: {
                        previous_dropout: 'Previous Dropout',
                        grade_retention: 'Grade Retention',
                        school_changes: 'School Changes'
                    }
                },
                'Digital Footprint': {
                    icon: 'fa-laptop',
                    fields: ['lms_activity', 'online_engagement'],
                    labels: {
                        lms_activity: 'LMS Activity',
                        online_engagement: 'Online Engagement'
                    }
                }
            };

            let formDataHtml = `
                <div class="assessment-data-container">
                    <div class="text-center mb-4">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-clipboard-data me-2"></i>
                            Detailed Assessment Metrics
                        </h6>
                        <p class="text-muted small mb-0">
                            Comprehensive breakdown of all assessment responses and performance indicators
                        </p>
                    </div>
                    <div class="accordion assessment-accordion" id="formDataAccordion">
            `;

            Object.entries(categories).forEach(([categoryName, category], index) => {
                const hasData = category.fields.some(field => formData[field] !== undefined && formData[field] !== null);
                
                if (hasData) {
                    formDataHtml += `
                        <div class="accordion-item assessment-category animate-slide-in" style="animation-delay: ${index * 150}ms; opacity: 1;">
                            <h2 class="accordion-header assessment-header" id="heading${index}">
                                <button class="accordion-button ${index > 0 ? 'collapsed' : ''} assessment-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                    <div class="d-flex align-items-center w-100">
                                        <div class="assessment-icon me-3">
                                            <i class="fas ${category.icon}"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0 fw-semibold">${categoryName}</h6>
                                            <small class="text-muted opacity-75">${category.fields.filter(field => formData[field] !== undefined).length} metrics</small>
                                        </div>
                                        <div class="assessment-stats me-2">
                                            <span class="badge bg-primary rounded-pill">
                                                ${category.fields.filter(field => formData[field] !== undefined).length}
                                            </span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''} assessment-collapse" data-bs-parent="#formDataAccordion">
                                <div class="accordion-body assessment-body">
                                    <div class="row g-3">
                    `;

                    category.fields.forEach((field, fieldIndex) => {
                        if (formData[field] !== undefined && formData[field] !== null) {
                            const value = formData[field];
                            const label = category.labels[field] || field;
                            
                            // Determine progress bar color and status based on value
                            let colorClass = 'bg-success';
                            let statusText = 'Excellent';
                            let statusIcon = 'fa-check-circle';
                            
                            if (value >= 70) {
                                colorClass = 'bg-danger';
                                statusText = 'Needs Attention';
                                statusIcon = 'fa-exclamation-triangle';
                            } else if (value >= 40) {
                                colorClass = 'bg-warning';
                                statusText = 'Fair';
                                statusIcon = 'fa-exclamation-circle';
                            }

                            formDataHtml += `
                                <div class="col-md-6 mb-3 assessment-metric animate-fade-in" style="animation-delay: ${(index * 150) + (fieldIndex * 50)}ms; opacity: 1;">
                                    <div class="metric-card">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="metric-label">
                                                <small class="fw-medium text-dark">${label}</small>
                                            </div>
                                            <div class="metric-value">
                                                <span class="badge ${colorClass} metric-badge" data-value="${value}">
                                                    <i class="fas ${statusIcon} me-1"></i>${value}/100
                                                </span>
                                            </div>
                                        </div>
                                        <div class="progress metric-progress" style="height: 8px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated ${colorClass} metric-progress-bar" 
                                                 style="width: 0%;" 
                                                 data-target="${value}%">
                                                <span class="sr-only">${value}% ${label}</span>
                                            </div>
                                        </div>
                                        <div class="metric-status mt-1">
                                            <small class="text-muted">
                                                <i class="fas ${statusIcon} me-1"></i>${statusText}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });

                    formDataHtml += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            formDataHtml += '</div></div>';
            document.getElementById('formDataDisplay').innerHTML = formDataHtml;

            // Animate the assessment data after DOM update
            setTimeout(() => {
                // Animate accordion items
                const accordionItems = document.querySelectorAll('.animate-slide-in');
                accordionItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                        item.style.transition = 'all 0.6s ease-out';
                    }, index * 100);
                });

                // Animate metric cards
                const metricCards = document.querySelectorAll('.animate-fade-in');
                metricCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                        card.style.transition = 'all 0.4s ease-out';
                    }, index * 50);
                });

                // Animate progress bars
                const progressBars = document.querySelectorAll('.metric-progress-bar');
                progressBars.forEach((bar, index) => {
                    setTimeout(() => {
                        const targetWidth = bar.getAttribute('data-target');
                        bar.style.width = targetWidth;
                        bar.style.transition = 'width 1.2s ease-out';
                        
                        // Animate the value badge
                        const valueBadge = bar.closest('.assessment-metric').querySelector('.metric-badge');
                        if (valueBadge) {
                            const targetValue = parseInt(valueBadge.getAttribute('data-value'));
                            animateMetricValue(valueBadge, 0, targetValue, 1200);
                        }
                    }, index * 100);
                });
            }, 200);
        }

        // Function to animate metric values
        function animateMetricValue(element, start, end, duration) {
            const startTime = performance.now();
            const icon = element.querySelector('i');
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const currentValue = Math.round(start + (end - start) * easeOutQuad(progress));
                element.innerHTML = `<i class="${icon.className} me-1"></i>${currentValue}/100`;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // Load risk assessment data when tab is activated
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for risk assessment tab
            const riskTab = document.querySelector('a[href="#risk-assessment"]');
            if (riskTab) {
                riskTab.addEventListener('shown.bs.tab', function () {
                    loadRiskAssessmentData();
                });
            }
            
            // Add event listener for course recommendations tab
            const courseRecTab = document.querySelector('a[href="#course-recommendations"]');
            if (courseRecTab) {
                courseRecTab.addEventListener('shown.bs.tab', function () {
                    console.log('Course recommendations tab activated');
                    
                    // Animate the tab content entrance
                    const tabPane = document.getElementById('course-recommendations');
                    tabPane.style.opacity = '0';
                    tabPane.style.transform = 'translateY(10px)';
                    
                    setTimeout(() => {
                        tabPane.style.opacity = '1';
                        tabPane.style.transform = 'translateY(0)';
                    }, 100);
                    
                    // Animate stream selection buttons
                    const streamButtons = document.querySelectorAll('.stream-btn');
                    streamButtons.forEach((btn, index) => {
                        btn.style.opacity = '0';
                        btn.style.transform = 'translateY(-20px)';
                        
                        setTimeout(() => {
                            btn.style.opacity = '1';
                            btn.style.transform = 'translateY(0)';
                        }, 200 + (index * 100));
                    });
                });
            }
            
            // Add tab event listener for tracking scores
            const trackingScoresTab = document.querySelector('a[href="#tracking-scores"]');
            if (trackingScoresTab) {
                trackingScoresTab.addEventListener('shown.bs.tab', function () {
                    console.log('Tracking scores tab activated, refreshing data...');
                    // Reload dashboard data to ensure latest quiz results
                    const userId = currentUserId || localStorage.getItem('dashboard_user_id') || 'anonymous';
                    fetch(`/api/dashboard/${userId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.tracking_scores) {
                                updateTrackingScores(data.tracking_scores);
                            }
                        })
                        .catch(error => {
                            console.error('Error refreshing tracking scores data:', error);
                        });
                });
            }
            
            // Also load risk data on initial page load if user has assessment data
            // This ensures the risk tab shows data immediately when opened
            const userId = currentUserId || localStorage.getItem('dashboard_user_id') || 'anonymous';
            fetch(`/api/dashboard/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.dropout_assessment) {
                        // Pre-populate the risk display with existing data
                        updateRiskDisplay(data.dropout_assessment);
                    }
                })
                .catch(error => {
                    console.error('Error pre-loading risk data:', error);
                });
        });

        function loadRiskAssessmentData() {
            const userId = currentUserId || localStorage.getItem('dashboard_user_id') || 'anonymous';
            
            // Show loading state
            document.getElementById('riskPercentage').textContent = 'Loading...';
            document.getElementById('riskLevel').textContent = 'Loading...';
            document.getElementById('riskDescription').textContent = 'Loading your assessment data...';
            
            // Fetch dashboard data (which now includes form data)
            fetch(`/api/dashboard/${userId}`)
                .then(response => response.json())
                .then(data => {
                    // Handle dropout assessment data
                    if (data.dropout_assessment) {
                        updateRiskDisplay(data.dropout_assessment);
                    } else {
                        // No assessment data available
                        document.getElementById('riskPercentage').textContent = 'No Data';
                        document.getElementById('riskLevel').textContent = 'No Assessment';
                        document.getElementById('riskLevel').className = 'text-muted';
                        document.getElementById('riskDescription').textContent = 'Complete a risk assessment to see your results.';
                        
                        // Clear breakdown and recommendations
                        document.getElementById('riskBreakdown').innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-chart-pie fa-2x mb-2"></i>
                                <p>Complete a risk assessment to see detailed breakdown.</p>
                            </div>
                        `;
                        
                        document.getElementById('riskRecommendations').innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-lightbulb fa-2x mb-2"></i>
                                <p>Complete a risk assessment to get personalized recommendations.</p>
                            </div>
                        `;
                    }
                    
                    // Handle form data display
                    if (data.form_data) {
                        updateFormDataDisplay(data.form_data);
                    } else {
                        document.getElementById('formDataDisplay').innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                                <p>Complete a risk assessment to see your form data.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading risk assessment data:', error);
                    // Show error state
                    document.getElementById('riskPercentage').textContent = 'Error';
                    document.getElementById('riskLevel').textContent = 'Error';
                    document.getElementById('riskLevel').className = 'text-danger';
                    document.getElementById('riskDescription').textContent = 'Failed to load assessment data. Please try again.';
                });
        }

        // Initialize risk trend chart
        function initRiskTrendChart() {
            const ctx = document.getElementById('riskTrendChart');
            if (!ctx) return;

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                // Load Chart.js if not available
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = function() {
                    createRiskTrendChart(ctx);
                };
                document.head.appendChild(script);
            } else {
                createRiskTrendChart(ctx);
            }
        }

        function createRiskTrendChart(ctx) {
            // Try to get real trend data from the API
            const userId = currentUserId || localStorage.getItem('dashboard_user_id') || 'anonymous';
            
            fetch(`/api/dropout-risk/trends/${userId}`)
                .then(response => response.json())
                .then(trendData => {
                    if (trendData && trendData.trends && trendData.trends.length > 0) {
                        // Use real trend data
                        const labels = trendData.trends.map(item => item.date);
                        const data = trendData.trends.map(item => item.risk_score);
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Risk Score',
                                    data: data,
                                    borderColor: '#4361ee',
                                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        // No trend data available - show placeholder
                        showNoTrendData(ctx);
                    }
                })
                .catch(error => {
                    console.error('Error loading trend data:', error);
                    // Show placeholder chart on error
                    showNoTrendData(ctx);
                });
        }

        function showNoTrendData(ctx) {
            // Clear any existing chart
            const canvas = ctx.canvas;
            const context = ctx.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            // Show no data message
            ctx.font = '14px Arial';
            ctx.fillStyle = '#6c757d';
            ctx.textAlign = 'center';
            ctx.fillText('No trend data available', canvas.width / 2, canvas.height / 2 - 10);
            ctx.fillText('Complete multiple assessments to see trends', canvas.width / 2, canvas.height / 2 + 10);
        }

        // Selected Colleges Functions
        let selectedCollegesData = [];

        function getCurrentUserId() {
            let userId = localStorage.getItem('user_id') || localStorage.getItem('dashboard_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('user_id', userId);
                localStorage.setItem('dashboard_user_id', userId);
            }
            return userId;
        }

        async function loadSelectedColleges() {
            try {
                const userId = getCurrentUserId();
                const container = document.getElementById('selectedCollegesContainer');
                
                // Show loading state
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Loading your selected colleges...</p>
                    </div>
                `;

                const response = await fetch(`/api/college-selection/${userId}`);
                const data = await response.json();

                if (data.status === 'success') {
                    selectedCollegesData = data.selected_institutions || [];
                    renderSelectedColleges();
                } else {
                    throw new Error(data.message || 'Failed to load selected colleges');
                }
            } catch (error) {
                console.error('Error loading selected colleges:', error);
                const container = document.getElementById('selectedCollegesContainer');
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                        <h5>Unable to load selected colleges</h5>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-primary" onclick="loadSelectedColleges()">Try Again</button>
                    </div>
                `;
            }
        }

        function renderSelectedColleges() {
            const container = document.getElementById('selectedCollegesContainer');
            
            if (selectedCollegesData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-university fa-2x text-muted mb-3"></i>
                        <h5>No Colleges Selected</h5>
                        <p class="text-muted">You haven't selected any colleges yet. Start exploring and add colleges to compare them.</p>
                        <a href="/institution_directory/" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Browse Colleges
                        </a>
                    </div>
                `;
                return;
            }

            let collegesHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="mb-0"><i class="fas fa-university me-2"></i>Selected Colleges (${selectedCollegesData.length})</h6>
                    </div>
                    <div class="col-md-6 text-end">
                        ${selectedCollegesData.length >= 2 ? 
                            `<button class="btn btn-sm btn-outline-primary" onclick="showComparison()">
                                <i class="fas fa-balance-scale me-1"></i>Compare All
                            </button>` : ''
                        }
                    </div>
                </div>
                <div class="row">
            `;

            selectedCollegesData.forEach((college, index) => {
                collegesHTML += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 border-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-truncate" title="${college.name}">${college.name}</h6>
                                    <span class="badge bg-primary">${college.category || 'General'}</span>
                                </div>
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-map-marker-alt me-1"></i>${college.city || 'N/A'}, ${college.state || 'N/A'}
                                </p>
                                <div class="mb-2">
                                    <div class="d-flex align-items-center">
                                        <span class="text-warning me-1">
                                            ${generateStars(college.rating || 0)}
                                        </span>
                                        <small class="text-muted">(${college.rating || 0}/5)</small>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-rupee-sign me-1"></i>${college.fees_range || 'N/A'}
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-briefcase me-1"></i>${college.placement_rate || 'N/A'} Placement
                                    </small>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <a href="/institution_directory/" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-search me-1"></i>View
                                    </a>
                                    <button class="btn btn-sm btn-info me-1" onclick="showCollegeDetails('${college.id}')">
                                        <i class="fas fa-info-circle me-1"></i>Details
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromSelection('${college.id}')">
                                        <i class="fas fa-times me-1"></i>Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            collegesHTML += `</div>`;
            container.innerHTML = collegesHTML;
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star text-warning"></i>';
            }
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt text-warning"></i>';
            }
            for (let i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++) {
                stars += '<i class="far fa-star text-warning"></i>';
            }
            
            return stars;
        }

        async function removeFromSelection(collegeId) {
            try {
                const userId = getCurrentUserId();
                
                // Get current selections
                const response = await fetch(`/api/college-selection/${userId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const currentSelections = data.selected_colleges || [];
                    const newSelections = currentSelections.filter(id => id !== collegeId);
                    
                    // Save updated selections
                    const saveResponse = await fetch('/api/college-selection/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            selected_colleges: newSelections
                        })
                    });
                    
                    if (saveResponse.ok) {
                        // Refresh the display
                        await loadSelectedColleges();
                    }
                }
            } catch (error) {
                console.error('Error removing college from selection:', error);
                alert('Failed to remove college. Please try again.');
            }
        }

        function showComparison() {
            if (selectedCollegesData.length < 2) {
                alert('Please select at least 2 colleges to compare');
                return;
            }
            
            const comparisonSection = document.getElementById('comparisonSection');
            const comparisonContainer = document.getElementById('comparisonContainer');
            
            // Generate comparison table
            let comparisonHTML = `
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                ${selectedCollegesData.map(college => `<th>${college.name}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Type</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.type || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Location</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.city || 'N/A'}, ${college.state || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Rating</strong></td>
                                ${selectedCollegesData.map(college => `<td>${generateStars(college.rating || 0)} ${college.rating || 0}/5</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Ranking</strong></td>
                                ${selectedCollegesData.map(college => `<td>#${college.ranking || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Established</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.established || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Accreditation</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.accreditation || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Courses</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.courses_offered ? college.courses_offered.slice(0, 3).join(', ') : 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Admission</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.admission_mode || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Fees</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.fees_range || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Placement</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.placement_rate || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Package</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.average_package || 'N/A'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>Hostel</strong></td>
                                ${selectedCollegesData.map(college => `<td>${college.hostel_facility ? ' Available' : ' Not Available'}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <h6>Specializations:</h6>
                    ${selectedCollegesData.map(college => `
                        <div class="mb-2">
                            <strong>${college.name}:</strong> ${college.specializations ? college.specializations.join(', ') : 'N/A'}
                        </div>
                    `).join('')}
                </div>
            `;
            
            comparisonContainer.innerHTML = comparisonHTML;
            comparisonSection.style.display = 'block';
            
            // Scroll to comparison section
            comparisonSection.scrollIntoView({ behavior: 'smooth' });
        }

        function closeComparison() {
            document.getElementById('comparisonSection').style.display = 'none';
        }

        function refreshSelectedColleges() {
            loadSelectedColleges();
        }

        async function showCollegeDetails(collegeId) {
            try {
                const modal = new bootstrap.Modal(document.getElementById('collegeDetailsModal'));
                const content = document.getElementById('collegeDetailsContent');
                const websiteLink = document.getElementById('collegeWebsiteLink');
                
                // Show loading state
                content.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Loading college details...</p>
                    </div>
                `;
                
                modal.show();
                
                // Fetch college details
                const response = await fetch(`/api/institutions/${collegeId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success' && data.institution) {
                    const college = data.institution;
                    renderCollegeDetails(college);
                    
                    // Update website link
                    if (college.website) {
                        websiteLink.href = college.website;
                        websiteLink.style.display = 'inline-block';
                    } else {
                        websiteLink.style.display = 'none';
                    }
                } else {
                    // If API fails, try to get from selected colleges data
                    const college = selectedCollegesData.find(c => c.id === collegeId);
                    if (college) {
                        renderCollegeDetails(college);
                        if (college.website) {
                            websiteLink.href = college.website;
                            websiteLink.style.display = 'inline-block';
                        } else {
                            websiteLink.style.display = 'none';
                        }
                    } else {
                        throw new Error('College not found');
                    }
                }
            } catch (error) {
                console.error('Error loading college details:', error);
                const content = document.getElementById('collegeDetailsContent');
                
                // Try to get from selected colleges data as fallback
                const college = selectedCollegesData.find(c => c.id === collegeId);
                if (college) {
                    renderCollegeDetails(college);
                    const websiteLink = document.getElementById('collegeWebsiteLink');
                    if (college.website) {
                        websiteLink.href = college.website;
                        websiteLink.style.display = 'inline-block';
                    } else {
                        websiteLink.style.display = 'none';
                    }
                } else {
                    content.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                            <h5>Unable to load college details</h5>
                            <p class="text-muted">${error.message}</p>
                            <button class="btn btn-primary" onclick="showCollegeDetails('${collegeId}')">Try Again</button>
                        </div>
                    `;
                }
            }
        }

        function renderCollegeDetails(college) {
            const content = document.getElementById('collegeDetailsContent');
            
            // Ensure college object exists and has required properties
            if (!college || !college.name) {
                content.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                        <h5>College Information Not Available</h5>
                        <p class="text-muted">Unable to display college details.</p>
                    </div>
                `;
                return;
            }
            
            let detailsHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <img src="${college.image_url || 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(college.name)}" 
                             alt="${college.name}" class="img-fluid rounded mb-3">
                    </div>
                    <div class="col-md-8">
                        <h3 class="text-primary mb-3">${college.name}</h3>
                        <p class="text-muted mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>${college.address || (college.city && college.state ? college.city + ', ' + college.state : 'Location not available')}
                        </p>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="text-warning me-2">
                                        ${generateStars(college.rating || 0)}
                                    </span>
                                    <strong>${college.rating || 0}/5</strong>
                                    <span class="text-muted ms-2">(${college.reviews_count || 0} reviews)</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <span class="badge bg-primary me-2">${college.category || 'General'}</span>
                                    <span class="badge bg-secondary">${college.type || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <p><strong>Established:</strong> ${college.established || 'N/A'}</p>
                                <p><strong>Ranking:</strong> ${college.ranking ? '#' + college.ranking : 'N/A'}</p>
                                <p><strong>Accreditation:</strong> ${college.accreditation || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Fees Range:</strong> ${college.fees_range || 'N/A'}</p>
                                <p><strong>Placement Rate:</strong> ${college.placement_rate || 'N/A'}</p>
                                <p><strong>Average Package:</strong> ${college.average_package || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-graduation-cap me-2"></i>Academic Information</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p><strong>Admission Mode:</strong> ${college.admission_mode || 'N/A'}</p>
                                <p><strong>Cutoff:</strong> ${college.cutoff || 'N/A'}</p>
                                <p><strong>Entrance Exam:</strong> ${college.entrance_exam || 'N/A'}</p>
                                <p><strong>Application Deadline:</strong> ${college.application_deadline || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-building me-2"></i>Campus Facilities</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p><strong>Hostel Facility:</strong> ${college.hostel_facility ? ' Available' : ' Not Available'}</p>
                                <p><strong>Sports Facilities:</strong> ${college.sports_facilities || 'N/A'}</p>
                                <p><strong>Library:</strong> ${college.library || 'N/A'}</p>
                                <p><strong>Laboratories:</strong> ${college.laboratories || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="mb-3"><i class="fas fa-book me-2"></i>Courses Offered</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                ${college.courses_offered && Array.isArray(college.courses_offered) && college.courses_offered.length > 0 ? 
                                    `<div class="row">
                                        ${college.courses_offered.slice(0, 6).map(course => 
                                            `<div class="col-md-6 col-lg-4 mb-2">
                                                <span class="badge bg-info text-dark me-2 mb-2">${course}</span>
                                            </div>`
                                        ).join('')}
                                    </div>` + 
                                    (college.courses_offered.length > 6 ? 
                                        `<p class="text-muted mt-2">... and ${college.courses_offered.length - 6} more courses</p>` : '')
                                    : '<p class="text-muted">No courses information available</p>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                ${college.specializations && Array.isArray(college.specializations) && college.specializations.length > 0 ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="mb-3"><i class="fas fa-star me-2"></i>Specializations</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    ${college.specializations.map(spec => 
                                        `<div class="col-md-6 col-lg-4 mb-2">
                                            <i class="fas fa-check-circle text-success me-2"></i>${spec}
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${college.description ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>About</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p>${college.description}</p>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-phone me-2"></i>Contact Information</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p><strong>Email:</strong> ${college.email || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${college.phone || 'N/A'}</p>
                                <p><strong>Website:</strong> <a href="${college.website || '#'}" target="_blank">${college.website || 'N/A'}</a></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-briefcase me-2"></i>Placement Highlights</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p><strong>Top Recruiters:</strong> ${college.top_recruiters && Array.isArray(college.top_recruiters) ? college.top_recruiters.join(', ') : 'N/A'}</p>
                                <p><strong>Highest Package:</strong> ${college.highest_package || 'N/A'}</p>
                                <p><strong>Average Package:</strong> ${college.average_package || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = detailsHTML;
        }

        // Load selected colleges when tab is activated
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for colleges tab
            const collegesTab = document.querySelector('a[href="#colleges"]');
            if (collegesTab) {
                collegesTab.addEventListener('shown.bs.tab', function () {
                    loadSelectedColleges();
                });
            }
        });
        
        // Stream Recommendation Results Display
        let currentStreamData = null;
        let streamUserId = localStorage.getItem('dashboard_user_id') || 'anonymous_' + Date.now();

        // Load stream data when tab is activated
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for stream recommendation tab
            const streamTab = document.querySelector('a[href="#recommendations"]');
            if (streamTab) {
                streamTab.addEventListener('shown.bs.tab', function () {
                    // Force reload the latest data every time tab is shown
                    console.log('Stream recommendation tab activated, reloading data...');
                    loadStreamRecommendationData();
                });
            }
            
            // Also load data initially if tab is active
            if (document.querySelector('#recommendations.active')) {
                loadStreamRecommendationData();
            }
        });

        function loadStreamRecommendationData() {
            console.log(' === LOADING STREAM RECOMMENDATION DATA ===');
            console.log(' Loading stream recommendation data for user:', streamUserId);
            
            // Show loading state
            const noDataDiv = document.getElementById('noStreamData');
            const dataDisplayDiv = document.getElementById('streamDataDisplay');
            
            noDataDiv.style.display = 'block';
            dataDisplayDiv.style.display = 'none';
            
            // ONLY check for stream data from user data store
            fetch('/api/dashboard/user/' + streamUserId)
            .then(response => response.json())
            .then(userData => {
                console.log(' === USER DATA FOR STREAM ===');
                console.log(' User data store response:', userData);
                console.log(' Stream data:', userData.stream);
                console.log(' Scores data:', userData.scores);
                console.log(' Predictions data:', userData.predictions);
                console.log(' Course recommendations data:', userData.course_recommendations);
                
                // ONLY display if we have actual stream assessment data
                if (userData.stream && userData.scores) {
                    console.log(' Found STREAM assessment data in user store:', userData);
                    displayStreamRecommendation({
                        recommended_stream: userData.stream,
                        scores: userData.scores,
                        predictions: userData.predictions
                    });
                    return; // Exit early if we found data
                }
                
                console.log(' No STREAM assessment data found, checking activities...');
                
                // If no data in user store, check activities for stream assessments ONLY
                fetch(`/api/dashboard/activity?user_id=${streamUserId}`)
                .then(response => response.json())
                .then(data => {
                    console.log(' === ACTIVITIES FOR STREAM ===');
                    console.log(' Activities response:', data);
                    
                    if (data.activities) {
                        // ONLY look for stream assessment activities, NOT course recommendations
                        const streamActivities = data.activities.filter(activity =>
                            activity.type === 'stream_assessment' || 
                            activity.title.includes('Stream Assessment') ||
                            (activity.data && activity.data.recommended_stream)
                        );
                        
                        console.log(' Stream assessment activities found:', streamActivities);
                        
                        if (streamActivities.length > 0) {
                            streamActivities.sort((a, b) => {
                                const dateA = new Date(a.timestamp || a.data?.timestamp || 0);
                                const dateB = new Date(b.timestamp || b.data?.timestamp || 0);
                                return dateB - dateA;
                            });
                            
                            const latestActivity = streamActivities[0];
                            console.log(' Latest stream assessment found:', latestActivity);
                            
                            if (latestActivity.data && latestActivity.data.recommended_stream) {
                                displayStreamRecommendation(latestActivity.data);
                                return;
                            } else {
                                console.log(' Activity found but no stream data in activity.data');
                            }
                        } else {
                            console.log(' No stream assessment activities found');
                        }
                    } else {
                        console.log(' No activities found for user');
                    }
                    console.log(' No stream assessment data found, showing no data message');
                    showNoStreamData();
                })
                .catch(error => {
                    console.error(' Error loading activities:', error);
                    showNoStreamData();
                });
            })
            .catch(error => {
                console.error(' Error loading user data:', error);
                showNoStreamData();
            });
        }

        function showNoStreamData() {
            const noDataDiv = document.getElementById('noStreamData');
            const dataDisplayDiv = document.getElementById('streamDataDisplay');
            
            noDataDiv.style.display = 'block';
            dataDisplayDiv.style.display = 'none';
        }

        function displayStreamRecommendation(streamData) {
            console.log(' === DISPLAYING STREAM RECOMMENDATION ===');
            console.log(' Displaying stream recommendation with data:', streamData);
            
            const noDataDiv = document.getElementById('noStreamData');
            const dataDisplayDiv = document.getElementById('streamDataDisplay');
            
            // Hide no data message and show results
            noDataDiv.style.display = 'none';
            dataDisplayDiv.style.display = 'block';
            
            // Store the data for later use
            currentStreamData = {
                stream: streamData.recommended_stream,
                scores: streamData.scores,
                predictions: streamData.predictions
            };
            
            console.log(' Stored currentStreamData:', currentStreamData);
            
            // Create results HTML
            let resultsHTML = `
                <div class="alert alert-success mb-4">
                    <h6 class="alert-heading"><i class="fas fa-trophy me-2"></i>Your Stream Recommendation</h6>
                    <h4 class="mb-2">${streamData.recommended_stream}</h4>
                    <p class="mb-0">Based on your assessment results from the training page</p>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Stream Probability Analysis</h6>
                            </div>
                            <div class="card-body">
                                <div id="streamChart" style="width: 100%; height: 400px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Assessment Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <small class="text-muted">Best Match</small>
                                    <h5 class="text-primary mb-0">${streamData.recommended_stream}</h5>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Assessment Date</small>
                                    <p class="mb-0">${new Date().toLocaleDateString()}</p>
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary" onclick="viewDetailedResults()">
                                        <i class="fas fa-eye me-2"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AI Career Advisor</h6>
                            </div>
                            <div class="card-body">
                                <button id="toggleInsights" class="btn btn-sm btn-outline-primary w-100" onclick="toggleAIInsights()">
                                    <i class="fas fa-lightbulb me-2"></i>Get Career Insights
                                </button>
                                <div id="insightsContent" style="display: none;" class="mt-3">
                                    <div class="insights-loading text-center py-2">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="small mt-1 mb-0">Generating insights...</p>
                                    </div>
                                    <div id="insightsText" class="insights-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            console.log(' Setting HTML to streamDataDisplay');
            dataDisplayDiv.innerHTML = resultsHTML;
            
            // Create chart if we have predictions
            if (streamData.predictions && streamData.predictions.length > 0) {
                console.log(' Creating chart with predictions:', streamData.predictions);
                createStreamChart(streamData.predictions);
            } else {
                console.log(' No predictions data available for chart');
            }
        }

        function createStreamChart(predictions) {
            const chartData = [{
                x: predictions.map(item => item.stream),
                y: predictions.map(item => item.probability),
                type: 'bar',
                marker: {
                    color: ['#4361ee', '#3f37c9', '#4cc9f0', '#4895ef', '#3a0ca3'],
                    line: {
                        color: 'rgba(255,255,255,0.8)',
                        width: 2
                    },
                    opacity: 0.9
                },
                text: predictions.map(item => `${item.probability.toFixed(1)}%`),
                textposition: 'outside'
            }];

            const layout = {
                title: 'Stream Recommendation Probabilities',
                xaxis: {
                    title: 'Streams',
                    tickfont: {
                        family: 'Poppins, sans-serif',
                        size: 12,
                        color: '#636363'
                    },
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.05)'
                },
                yaxis: {
                    title: 'Probability (%)',
                    tickfont: {
                        family: 'Poppins, sans-serif',
                        size: 12,
                        color: '#636363'
                    },
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.05)'
                },
                showlegend: false,
                paper_bgcolor: 'rgba(255,255,255,0.7)',
                plot_bgcolor: 'rgba(255,255,255,0.3)',
                margin: { t: 50, l: 50, r: 30, b: 70 },
                hovermode: 'closest'
            };

            // Create the plot
            Plotly.newPlot('streamChart', chartData, layout);
        }

        function viewDetailedResults() {
            if (currentStreamData && currentStreamData.scores) {
                let scoresHTML = '<div class="row">';
                
                // Academic scores
                const academicSubjects = ['math', 'science', 'biology', 'english', 'social', 'language'];
                scoresHTML += '<div class="col-md-6"><h6>Academic Performance</h6>';
                academicSubjects.forEach(subject => {
                    if (currentStreamData.scores[subject]) {
                        scoresHTML += `<div class="d-flex justify-content-between mb-2">
                            <span>${subject.charAt(0).toUpperCase() + subject.slice(1)}</span>
                            <span class="badge bg-primary">${currentStreamData.scores[subject]}%</span>
                        </div>`;
                    }
                });
                scoresHTML += '</div>';
                
                // Skills scores
                const skillSubjects = ['logical', 'analytical', 'numerical', 'creativity', 'communication', 'artistic', 'practical'];
                scoresHTML += '<div class="col-md-6"><h6>Skills Assessment</h6>';
                skillSubjects.forEach(skill => {
                    if (currentStreamData.scores[skill]) {
                        scoresHTML += `<div class="d-flex justify-content-between mb-2">
                            <span>${skill.charAt(0).toUpperCase() + skill.slice(1)}</span>
                            <span class="badge bg-success">${currentStreamData.scores[skill]}%</span>
                        </div>`;
                    }
                });
                scoresHTML += '</div>';
                
                scoresHTML += '</div>';
                
                // Show modal with detailed results
                const modalHTML = `
                    <div class="modal fade" id="detailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Detailed Assessment Results</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${scoresHTML}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('detailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body and show it
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                modal.show();
            }
        }

        function toggleAIInsights() {
            const insightsContent = document.getElementById('insightsContent');
            const toggleBtn = document.getElementById('toggleInsights');
            const isVisible = insightsContent.style.display === 'block';
            
            insightsContent.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible && !window.insightsLoaded && currentStreamData) {
                loadAIInsights();
            }
        }

        async function loadAIInsights() {
            const insightsContainer = document.getElementById('insightsContent');
            const loadingElement = insightsContainer.querySelector('.insights-loading');
            const insightsText = document.getElementById('insightsText');
            
            try {
                const response = await fetch('/get_insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stream: currentStreamData.stream,
                        scores: currentStreamData.scores
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    insightsText.innerHTML = `
                        <div class="alert alert-info">
                            <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Personalized Career Insights</h6>
                            <p class="mb-0">${data.insights}</p>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Error loading insights');
                }
            } catch (error) {
                console.error('Error loading insights:', error);
                insightsText.innerHTML = `
                    <div class="alert alert-warning">
                        <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Unable to Load Insights</h6>
                        <p class="mb-0">Please try again later.</p>
                    </div>
                `;
            } finally {
                loadingElement.style.display = 'none';
                window.insightsLoaded = true;
            }
        }

        // Load course recommendation data when tab is activated
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for course recommendation tab
            const courseTab = document.querySelector('a[href="#course-recommendations"]');
            if (courseTab) {
                courseTab.addEventListener('shown.bs.tab', function () {
                    loadCourseRecommendationData();
                });
            }
            
            // Also load data initially if tab is active
            if (document.querySelector('#course-recommendations.active')) {
                loadCourseRecommendationData();
            }
        });

        function loadCourseRecommendationData() {
            console.log(' === LOADING COURSE RECOMMENDATION DATA ===');
            console.log(' Loading course recommendation data for user:', streamUserId);
            
            // Show loading state
            const noDataDiv = document.getElementById('noCourseData');
            const dataDisplayDiv = document.getElementById('courseDataDisplay');
            
            noDataDiv.style.display = 'block';
            dataDisplayDiv.style.display = 'none';
            
            // First check user data store directly (this should have the latest data)
            fetch('/api/dashboard/user/' + streamUserId)
            .then(response => response.json())
            .then(userData => {
                console.log(' DEBUG: === USER DATA FOR COURSES ===');
                console.log(' DEBUG: User data store response for courses:', userData);
                console.log(' DEBUG: Stream data:', userData.stream);
                console.log(' DEBUG: Course recommendations data:', userData.course_recommendations);
                console.log(' DEBUG: All user data keys:', Object.keys(userData));
                
                if (userData.course_recommendations && userData.course_recommendations.all_stream_recommendations) {
                    console.log(' Found COURSE data in user store:', userData.course_recommendations);
                    
                    // Convert course data to the format expected by displayCourseRecommendations
                    const courseActivities = [];
                    Object.keys(userData.course_recommendations.all_stream_recommendations).forEach(stream => {
                        const recommendations = userData.course_recommendations.all_stream_recommendations[stream];
                        if (recommendations && recommendations.length > 0) {
                            courseActivities.push({
                                data: {
                                    stream: stream,
                                    recommendations: recommendations,
                                    timestamp: userData.last_updated || new Date().toISOString()
                                }
                            });
                        }
                    });
                    
                    console.log(' DEBUG: Converted course activities:', courseActivities);
                    
                    if (courseActivities.length > 0) {
                        console.log(' Displaying COURSE activities:', courseActivities);
                        displayCourseRecommendations(courseActivities);
                        return;
                    } else {
                        console.log(' Course activities converted but empty');
                    }
                } else {
                    console.log(' No course_recommendations.all_stream_recommendations found');
                    console.log(' DEBUG: course_recommendations structure:', userData.course_recommendations);
                }
                
                console.log(' No COURSE data in user store, checking activities...');
                fetch(`/api/dashboard/activity?user_id=${streamUserId}`)
                .then(response => response.json())
                .then(data => {
                    console.log(' Course activities response:', data);
                    
                    if (data.activities) {
                        // Look for course recommendation activities
                        const courseActivities = data.activities.filter(activity => 
                            activity.type === 'course_recommendation' || 
                            activity.title.includes('Course Recommendation') ||
                            activity.page.includes('/courses')
                        );
                        
                        console.log(' Course activities found:', courseActivities);
                        
                        if (courseActivities.length > 0) {
                            console.log('Course recommendation activities found:', courseActivities);
                            displayCourseRecommendations(courseActivities);
                            return;
                        }
                    }
                    
                    console.log(' No course data found, showing no data message');
                    showNoCourseData();
                })
                .catch(error => {
                    console.log('Error loading course data from activities:', error);
                    showNoCourseData();
                });
            })
            .catch(error => {
                console.log('Error loading course data from user store:', error);
                showNoCourseData();
            });
        }

        function showNoCourseData() {
            const noDataDiv = document.getElementById('noCourseData');
            const dataDisplayDiv = document.getElementById('courseDataDisplay');
            
            noDataDiv.style.display = 'block';
            dataDisplayDiv.style.display = 'none';
        }

        function displayCourseRecommendations(courseActivities) {
            console.log(' === DISPLAYING COURSE RECOMMENDATIONS ===');
            console.log(' Displaying course recommendations with data:', courseActivities);
            
            const noDataDiv = document.getElementById('noCourseData');
            const dataDisplayDiv = document.getElementById('courseDataDisplay');
            
            // Hide no data message and show results
            noDataDiv.style.display = 'none';
            dataDisplayDiv.style.display = 'block';
            
            // Group recommendations by stream
            const recommendationsByStream = {};
            let dataIndex = 0; // Track data indices for global storage
            
            courseActivities.forEach(activity => {
                const stream = activity.data.stream || 'unknown';
                if (!recommendationsByStream[stream]) {
                    recommendationsByStream[stream] = [];
                }
                recommendationsByStream[stream].push(activity.data);
                
                // Store recommendations data in global variable
                window.courseDetailsData[dataIndex] = activity.data.recommendations || [];
                dataIndex++;
            });
            
            console.log(' Grouped recommendations by stream:', recommendationsByStream);
            console.log(' Stored course data indices:', Object.keys(window.courseDetailsData));
            
            // Create results HTML
            let resultsHTML = '<div class="row">';
            let currentIndex = 0; // Reset counter for button generation
            
            Object.keys(recommendationsByStream).forEach(stream => {
                const streamData = recommendationsByStream[stream][0]; // Get latest for each stream
                const streamInfo = getStreamInfo(stream);
                
                console.log(' Processing stream:', stream, 'with data:', streamData);
                
                resultsHTML += `
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-gradient-${streamInfo.color} text-white">
                                <h6 class="mb-0">
                                    <i class="${streamInfo.icon} me-2"></i>${streamInfo.title} Courses
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="course-list">
                                    ${generateCourseList(streamData.recommendations || [])}
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">Assessment Date: ${new Date(streamData.timestamp).toLocaleDateString()}</small>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-outline-${streamInfo.color} btn-sm" onclick="viewCourseDetails('${stream}', ${currentIndex})">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                currentIndex++; // Increment for next stream
            });
            
            resultsHTML += '</div>';
            
            dataDisplayDiv.innerHTML = resultsHTML;
        }

        function getStreamInfo(stream) {
            const streamMap = {
                'arts': { title: 'Arts', icon: 'fas fa-palette', color: 'primary' },
                'commerce': { title: 'Commerce', icon: 'fas fa-coins', color: 'success' },
                'pcm': { title: 'PCM', icon: 'fas fa-flask', color: 'info' },
                'pcb': { title: 'PCB', icon: 'fas fa-microscope', color: 'danger' },
                'vocational': { title: 'Vocational', icon: 'fas fa-tools', color: 'warning' }
            };
            return streamMap[stream] || { title: stream, icon: 'fas fa-graduation-cap', color: 'secondary' };
        }

        function generateCourseList(recommendations) {
            console.log(' DEBUG: generateCourseList called with:', recommendations);
            
            if (!recommendations || recommendations.length === 0) {
                console.log(' DEBUG: No recommendations to display');
                return '<p class="text-muted">No recommendations available</p>';
            }
            
            let html = '';
            recommendations.slice(0, 3).forEach((course, index) => {
                // Handle both old and new format
                const courseName = course.course || course.name || course.Course || 'Course ' + (index + 1);
                const score = course.probability || course.score || course.Similarity || 85;
                
                console.log(` DEBUG: Processing course ${index}: ${courseName} with score ${score}`);
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <span class="fw-medium">${courseName}</span>
                        <span class="badge bg-${score > 80 ? 'success' : score > 60 ? 'warning' : 'secondary'}">${typeof score === 'number' ? Math.round(score) : score}%</span>
                    </div>
                `;
            });
            
            if (recommendations.length > 3) {
                html += `<small class="text-muted">and ${recommendations.length - 3} more courses...</small>`;
            }
            
            console.log(' DEBUG: Generated HTML:', html);
            return html;
        }

        // Global storage for course details data
        window.courseDetailsData = {};

        function viewCourseDetails(stream, dataIndex) {
            try {
                console.log(' viewCourseDetails called with stream:', stream, 'dataIndex:', dataIndex);
                
                const recommendations = window.courseDetailsData[dataIndex];
                if (!recommendations) {
                    console.error('Course data not found for index:', dataIndex);
                    console.error('Available indices:', Object.keys(window.courseDetailsData));
                    alert('Course data not found. Please try again.');
                    return;
                }
                
                console.log(' Course data found:', recommendations);
                
                const streamInfo = getStreamInfo(stream);
                
                let detailsHTML = `
                    <div class="modal fade" id="courseDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-gradient-${streamInfo.color} text-white">
                                    <h5 class="modal-title">
                                        <i class="${streamInfo.icon} me-2"></i>${streamInfo.title} Course Recommendations
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="course-details-list">
                `;
                
                recommendations.forEach((course, index) => {
                    const score = course.probability || course.score || course.Similarity || 85;
                    const courseName = course.course || course.name || course.Course || 'Course ' + (index + 1);
                    const careers = course.careers || course.Career || course.career || course['Career Options'] || [];
                    const description = course.description || course.Description || `Recommended course with ${Math.round(score)}% match`;
                    
                    // Handle careers as string or array
                    let careersList = [];
                    if (typeof careers === 'string') {
                        careersList = careers.split(',').map(c => c.trim()).filter(c => c);
                    } else if (Array.isArray(careers)) {
                        careersList = careers;
                    }
                    
                    detailsHTML += `
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${courseName}</h6>
                                <span class="badge bg-${score > 80 ? 'success' : score > 60 ? 'warning' : 'secondary'}">${Math.round(score)}% Match</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${description}</p>
                                ${careersList.length > 0 ? `
                                    <div class="mt-2">
                                        <small class="text-muted fw-bold">Career Options:</small>
                                        <div class="mt-1">
                                            ${careersList.slice(0, 3).map(career => 
                                                `<span class="badge bg-light text-dark me-1">${career}</span>`
                                            ).join('')}
                                            ${careersList.length > 3 ? `<span class="text-muted">+${careersList.length - 3} more</span>` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                detailsHTML += `
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <a href="/${stream}/courses/" class="btn btn-${streamInfo.color}">
                                        <i class="fas fa-redo me-1"></i>Retake Assessment
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('courseDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body and show it
                document.body.insertAdjacentHTML('beforeend', detailsHTML);
                const modal = new bootstrap.Modal(document.getElementById('courseDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error showing course details:', error);
                alert('Error showing course details. Please try again.');
            }
        }

        // Load Plotly.js for chart rendering
        if (typeof Plotly === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.plot.ly/plotly-latest.min.js';
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
